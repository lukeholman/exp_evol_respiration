---
title: "Desiccation and starvation resistance"
output: 
  workflowr::wflow_html:
    code_folding: hide 
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

## Load packages

```{r}
library(tidyverse)

library(coxme)
library(lme4)
library(brms)
library(tidybayes)
library(ggridges)

library(kableExtra)
library(knitrhooks) # install with devtools::install_github("nathaneastwood/knitrhooks")

output_max_height() # a knitrhook option

options(stringsAsFactors = FALSE)
```


## Load data
```{r, results='hide'}
# load desiccation resistance data
DesRes <- read.csv("data/3.DesRes.csv") %>% 
  # add event (all flies died)
  mutate(EVENT = 1,
         LINE = paste0(Treatment, substr(Replicate, 2, 2)),
         ID = paste(LINE, Vial, sep = ''))

# calculate survival times
# paste time and date
DesRes$d <- paste(DesRes$Death_date, DesRes$Death_time, sep = ' ')

# experiment start time
start_timeDes <- "04/02/2017 12:00"

DesRes$survival.time <- as.numeric(strptime(DesRes$d, format = "%d/%m/%Y %H") - strptime(start_timeDes, format = "%d/%m/%Y %H"))


# load starvation resistance data
StaRes <- read.csv("data/3.StarvRes.csv") %>% 
  # add event (all flies died)
  mutate(EVENT = 1,
         LINE = paste0(Treatment, substr(Replicate, 2, 2)),
         ID = paste(LINE, Vial, sep = ''))

# calculate survival times
# paste time and date
StaRes$d <- paste(StaRes$Death_date, StaRes$Death_time, sep = ' ')

# experiment start time
start_timeSta <- "04/02/2017 12:00"

StaRes$survival.time <- as.numeric(strptime(StaRes$d, format = "%d/%m/%Y %H") - strptime(start_timeSta, format = "%d/%m/%Y %H"))

# 5 individuals have missing survival times which we will right censor at max. survival time
# Two M females (M2) were right censored as survival time not recorded
# Three P females (P2 Vial 6 and P4 vial 9) were right censored as survival time not recorded
StaRes[which(is.na(StaRes$survival.time)), 'EVENT'] <- 0
StaRes[which(is.na(StaRes$survival.time)), 'survival.time'] <- max(na.omit(StaRes$survival.time))

```

## Inspecting the raw data

```{r, fig.height=3}
bind_rows(
  DesRes %>% 
  select(Treatment, Sex, survival.time) %>% mutate(var = 'Desiccation'),
  StaRes %>% filter(EVENT == 1) %>% 
  select(Treatment, Sex, survival.time) %>% mutate(var = 'Starvation')
) %>% 
  mutate(var2 = paste(Treatment, Sex)) %>% 
  ggplot(aes(x = survival.time, y = Sex, fill = var2)) +
  geom_boxplot() +
  scale_fill_manual(values = c("pink", "skyblue", "red", "blue"), name = "",
                    labels = c('Monogamy Females', 'Monogamy Males',
                               'Polandry Females', 'Polandry Males')) +
  labs(x = 'Survival time (hours)') +
  facet_wrap(~var, ncol = 2) +
  theme_bw() +
  NULL

```
**Figure 1:** Survival time in hours for flies in each treatment split by sex. 

# Survival analysis
We modeled desiccation and starvation resistance using survival analysis. We measured time in hours until death (`EVENT` = 1) for single sex triads of flies housed in vials (n = 7-10 vials per replicate per sex) containing no media and silica gel beads between the cotton and parafilm enclosing the vial (desiccation resistance) or an agar media providing moisture only (starvation resistance). We monitored vials for deaths every two hours until all flies perished. For the starvation resistance assay five individuals (two M females and three P females) were right censored (`EVENT` = 0) at the end of the observation period as death times were not recorded or remained alive. 

### Kaplan-Meier survival curve
First we plot Kaplan-Meier survival curves. 

```{r, fig.width=5, fig.height=3}
survminer::ggsurvplot(survfit(Surv(survival.time, EVENT) ~ Treatment + Sex, data = DesRes),
                      conf.int = TRUE,
                      risk.table = FALSE,
                      linetype = "Sex",
                      palette = c("pink", "skyblue", "red", "blue"),
                      xlab = "Time (hours)",
                      legend = 'right',
                      legend.title = "",
                      legend.labs = c("Monogamy \u2640","Monogamy \u2642",
                                      'Polandry \u2640','Polandry \u2642'),
                      break.time.by = 12,
                      ggtheme = theme_bw()) 

survminer::ggsurvplot(survfit(Surv(survival.time, EVENT) ~ Treatment + Sex, data = StaRes),
                      conf.int = TRUE,
                      risk.table = FALSE,
                      linetype = "Sex",
                      palette = c("pink", "skyblue", "red", "blue"),
                      xlab = "Time (hours)",
                      legend = 'right',
                      legend.title = "",
                      legend.labs = c("Monogamy \u2640","Monogamy \u2642",
                                      'Polandry \u2640','Polandry \u2642'),
                      break.time.by = 12,
                      ggtheme = theme_bw()) 

```
**Figure 2:** Kaplan-Meier survival curves for flies in each treatment split by sex. + indicates censored individuals (n = 5).

### Check proportional hazards assumption
Next we need to check that the proportional hazards assumption is not violated before fitting the model, where crossing hazards (lines) indicate violation of the proportional hazards assumption. For both desiccation and starvation we see crossing hazards for the male survival curves. We will therefore fit accelerated failure time (AFT) models with a Weibull distribution (see [here](https://pubmed.ncbi.nlm.nih.gov/17080754/)).
```{r, fig.width=8, fig.height=4}
# assess proportional hazards assumption
par(mar = c(2, 2, 2, 2), mfrow = c(1, 2))
plot(survfit(Surv(survival.time, EVENT) ~ Treatment + Sex, data = DesRes), 
     lty = 1:2, lwd = 2,
     col = c("pink", "skyblue", "red", "blue"), 
     main = 'Desiccation',
     fun = "cloglog")

legend("topleft", c("M \u2640","M \u2642",'P \u2640','P \u2642'), 
       col = c("pink", "skyblue", "red", "blue"), 
       lty = 1:2, 
       lwd = 2,
       bty = 'n'
)

plot(survfit(Surv(survival.time, EVENT) ~ Treatment + Sex, data = StaRes), 
     lty = 1:2, lwd = 2,
     col = c("pink", "skyblue", "red", "blue"), 
     main = 'Starvation',
     fun = "cloglog")

par(mfrow = c(1, 1))

```

## Fit the survival models for desiccation and starvation resistance
We fit an accelerated failure time model in `brms` using `family = weibull()`, with time (hours) to event (death) as the response and sexual selection treatment (`Treatment`; Monogamy or Polyandry), `Sex` (female or male) and their interaction as predictors. [See here](https://bookdown.org/content/4857/god-spiked-the-integers.html) for a helpful explanation on fitting survival models in `brms`. We also include replicate treatment as a random intercept term for each of the 8 lines and a random slope term to allow the effect of selection treatment to vary across replicate lines. We also include vial `ID` as a random intercept term as individuals housed in the same vial may show a correlated response. 

```{r}

if(!file.exists("output/des_brm.rds")){ # if the model doesn't exist fit it, else load it
  
  des_brm <- brm(survival.time | cens(1 - EVENT) ~ Treatment * Sex + (Treatment|LINE) + (1|ID),
               prior = c(set_prior("normal(0,0.5)", class = "b"),
                         set_prior("cauchy(0,0.1)", class = "sd")),
               iter = 5000, chains = 4, cores = 4,
               control = list(max_treedepth = 20,
                              adapt_delta = 0.999),
               data = DesRes, family = weibull())
  
  saveRDS(des_brm, "output/des_brm.rds")
} else {
  des_brm <- readRDS('output/des_brm.rds')
}


if(!file.exists("output/sta_brm.rds")){ # if the model doesn't exist fit it, else load it
  
  sta_brm <- brm(survival.time | cens(EVENT) ~ Treatment * Sex + (Treatment|LINE) + (1|ID),
               prior = c(set_prior("normal(0,0.5)", class = "b"),
                         set_prior("cauchy(0,0.1)", class = "sd")),
               iter = 5000, chains = 4, cores = 4,
               control = list(max_treedepth = 20,
                              adapt_delta = 0.999),
               # brm uses 0 = event, 1 = censor so need to recode
               data = StaRes %>% mutate(EVENT = if_else(EVENT == 1, 0, 1)), 
               family = weibull())
  
  saveRDS(sta_brm, "output/sta_brm.rds")
} else {
  sta_brm <- readRDS('output/sta_brm.rds')
}

```

### Table of model parameter estimates - eclosion time {.tabset}

#### Formatted table 
Taking the exponent of the coefficients gives an estimate of the multiplicative effect of the time to event compared to baseline (Monogamy females) ([see here](http://rstudio-pubs-static.s3.amazonaws.com/5564_bc9e2d9a458c4660aa82882df90b7a6b.html)). For instance, for desiccation resistance, being male accelerates time to event by a factor of exp(`r round(fixef(des_brm)[3], 3)`) = `r round(exp(fixef(des_brm)[3]), 3)`, i.e. Monogamy males live `r round(exp(fixef(des_brm)[3]), 3)` times shorter than Monogamy females.

```{r}

des_test <- bind_rows(
  hypothesis(des_brm, 'TreatmentP = 0')$hypothesis,
  hypothesis(des_brm, 'Sexm = 0')$hypothesis,
  hypothesis(des_brm, 'TreatmentP:Sexm = 0')$hypothesis
) %>% 
  mutate(Parameter = c('Treatment (P)', 'Sex (M)', 'Treatment (P) x Sex (M)'),
         across(2:5, round, 3)) %>% 
  relocate(Parameter, Estimate, Est.Error, CI.Lower, CI.Upper, Star)

sta_test <- bind_rows(
  hypothesis(sta_brm, 'TreatmentP = 0')$hypothesis,
  hypothesis(sta_brm, 'Sexm = 0')$hypothesis,
  hypothesis(sta_brm, 'TreatmentP:Sexm = 0')$hypothesis
) %>% 
  mutate(Parameter = c('Treatment (P)', 'Sex (M)', 'Treatment (P) x Sex (M)'),
         across(2:5, round, 3)) %>% 
  relocate(Parameter, Estimate, Est.Error, CI.Lower, CI.Upper, Star)

des_pvals <- bayestestR::p_direction(des_brm) %>% 
  as.data.frame() %>%
  mutate(vars = map_chr(str_split(Parameter, "_"), ~ .x[2]),
         p_val = 1 - pd, 
         star = ifelse(p_val < 0.05, "\\*", "")) %>%
  select(vars, p_val, star)

sta_pvals <- bayestestR::p_direction(sta_brm) %>% 
  as.data.frame() %>%
  mutate(vars = map_chr(str_split(Parameter, "_"), ~ .x[2]),
         p_val = 1 - pd, 
         star = ifelse(p_val < 0.05, "\\*", "")) %>%
  select(vars, p_val, star)

bind_rows(
  des_test %>% 
    mutate(vars = c('TreatmentP', 'Sexm', 'TreatmentP.Sexm')) %>% 
    left_join(des_pvals %>% filter(vars != 'Intercept'), 
              by = c("vars")) %>% 
    select(Parameter, Estimate, Est.Error, CI.Lower, CI.Upper, `p` = p_val, star),
  sta_test %>% 
    mutate(vars = c('TreatmentP', 'Sexm', 'TreatmentP.Sexm')) %>% 
    left_join(sta_pvals %>% filter(vars != 'Intercept'), 
              by = c("vars")) %>% 
    select(Parameter, Estimate, Est.Error, CI.Lower, CI.Upper, `p` = p_val, star)
  ) %>% 
  mutate(p = ifelse(p > 0.001, round(p, 3), '< 0.001')) %>% 
  rename(` ` = star) %>%
  kable() %>% 
  kable_styling(full_width = FALSE) %>%
  group_rows("Desiccation", 1, 3) %>%
  group_rows("Starvation", 4, 6)

```

#### Complete output from `summary.brmsfit()` {.tabset}
The shape parameter ($1/$scale parameter; see [here](http://rstudio-pubs-static.s3.amazonaws.com/5564_bc9e2d9a458c4660aa82882df90b7a6b.html)) describes the change in hazard over time where: 

* $p$ = 1: constant hazard
* $p$ > 1: increasing hazard over time
* $p$ < 1: decreasing hazard over time

##### Desiccation 
```{r}
des_brm
```

##### Starvation 
```{r}
sta_brm
```

### Posterior effect size of treatment and sex on survival

```{r, fig.height=3, fig.width=7}
# get posterior predictions
post_des <- posterior_samples(des_brm) %>% 
  as_tibble() %>%
  select(contains("b_"), -contains("Intercept")) %>% 
  mutate(draw = 1:n()) %>% 
  pivot_longer(-draw) %>% 
  mutate(key = str_remove_all(name, "b_"))

post_sta <- posterior_samples(sta_brm) %>% 
  as_tibble() %>%
  select(contains("b_"), -contains("Intercept")) %>% 
  mutate(draw = 1:n()) %>% 
  pivot_longer(-draw) %>% 
  mutate(key = str_remove_all(name, "b_"))

bind_rows(post_des %>% mutate(var = 'Desiccation'), 
          post_sta %>% mutate(var = 'Starvation')) %>%
  mutate(key = recode(key, TreatmentP = "Treatment (P)", Sexm = 'Sex (M)', `TreatmentP:Sexm` = 'Treatment (P) x Sex (M)')) %>% 
  ggplot(aes(x = value, y = key, fill = key)) + 
  geom_vline(xintercept = 0, linetype = 2) + 
  stat_halfeye(alpha = .8) +
  scale_fill_brewer(palette = "Spectral") +
  coord_cartesian(xlim = c(-0.4, 0.4)) +
  labs(x = "Effect size", y = "Model parameter") +
  facet_wrap(~var) +
  theme_ridges() +
  theme(legend.position = 'none',
        legend.title = element_blank()) +
  NULL

```
