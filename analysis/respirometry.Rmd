---
title: "Respirometry"
output: 
  workflowr::wflow_html:
    code_folding: hide 
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Load R packages
```{r}
# it was slightly harder to install the showtext package. On Mac, I did this:
# installed 'homebrew' using Terminal: ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" 
# installed 'libpng' using Terminal: brew install libpng
# installed 'showtext' in R using: devtools::install_github("yixuan/showtext")  

library(tidyverse)
library(gridExtra)
library(grid)
library(brms)
library(RColorBrewer)
library(glue)
library(kableExtra)
library(tidybayes)
library(bayestestR)
library(MuMIn)
library(glue)
library(ggridges)
library(future)
library(future.apply)
library(GGally)
library(DT)
library(showtext)

library(knitrhooks) # install with devtools::install_github("nathaneastwood/knitrhooks")

output_max_height() # a knitrhook option
options(stringsAsFactors = FALSE)

# set up nice font for figure
nice_font <- "Lora"
font_add_google(name = nice_font, family = nice_font, regular.wt = 400, bold.wt = 700)
showtext_auto()

# Define function for the inverse logit
inv_logit <- function(x) 1 / (1 + exp(-x))
```

## Inspect the raw data

This analysis set out to test whether sexual selection treatment had an effect on respiration in the flies. The variables in the raw data are as follows:

- `SELECTION` The selection treatment of the focal triad of flies (monogamy or polyandry)
- `SEX` The sex of the focal triad of flies (male or female)
- `LINE` The replicate selection line (M1-4 and P1-4)
- `SAMPLE` Grouping variable that identifies the specific triad of flies (there are three measurements of each for all response variables except body weight). The have names like `M1T1F` (i.e. the first triad of females from line M1)
- `CYCLE` The respirometry cycle (three measurements were taken, with cycle I being the first and cycle III the last)
- `VO2` The amount of O$_2$ produced over the cycle
- `VCO2` The amount of CO$_2$ consumed over the cycle
- `RQ` The respiratory quotient, i.e. `VCO2` / `VO2`
- `ACTIVITY` The amount of locomotor activity by the triad of flies over the focal cycle; measured by infrared light
- `BODYMASS` The mass/weight of the triad of flies, measured to the nearest 0.1mg. 

We expect body weight and activity levels to vary between the sexes and potentially between treatments. In turn, we expect these two 'mediator variables' to co-vary with respiratory flux, e.g. because larger flies have more respiring tissue, and because more active flies would have more active metabolism. There might also be weight- and activity-independent effects of sex and selection treatment on respiration, e.g. because of differences in resting metabolic rate.

### Raw numbers 

```{r}
respiration <- read_csv("data/2.metabolic_rates.csv") %>%
  rename(SELECTION = `?SELECTION`,
         BODYMASS = BODY_WEIGHT)

my_data_table <- function(df){
  datatable(
    df, rownames=FALSE,
    autoHideNavigation = TRUE,
    extensions = c("Scroller",  "Buttons"),
    options = list(
      dom = 'Bfrtip',
      deferRender=TRUE,
      scrollX=TRUE, scrollY=400,
      scrollCollapse=TRUE,
      buttons = 
        list('csv', list(
          extend = 'pdf',
          pageSize = 'A4',
          orientation = 'landscape',
          filename = 'Dpseudo_respiration')),
      pageLength = 50
    )
  )
}

respiration %>%
  mutate_if(is.numeric, ~ format(round(.x, 3), nsmall = 3)) %>%
  my_data_table()
```


### Plot of correlations between variables

```{r fig.height=10, fig.width=10}
cols <- c("M females" = "pink", 
          "E females" = "red", 
          "M males" = "skyblue", 
          "E males" = "blue")

modified_densityDiag <- function(data, mapping, ...) {
  ggally_densityDiag(data, mapping, colour = "grey10", ...) + 
    scale_fill_manual(values = cols) + 
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE))
}

modified_points <- function(data, mapping, ...) {
  ggally_points(data, mapping, pch = 21, colour = "grey10", ...) +
    scale_fill_manual(values = cols) + 
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE))
}

modified_facetdensity <- function(data, mapping, ...) {
  ggally_facetdensity(data, mapping, ...) + 
    scale_colour_manual(values = cols)
}

modified_box_no_facet <- function(data, mapping, ...) {
  ggally_box_no_facet(data, mapping, colour = "grey10", ...) +
    scale_fill_manual(values = cols)
}

respiration_pairs_plot <- respiration %>% 
  select(SEX, SELECTION, CYCLE, VO2, VCO2, RQ, ACTIVITY, BODYMASS) %>%
  mutate(VO2 = VO2 * 1000, 
         VCO2 = VCO2 * 1000, 
         BODYMASS = BODYMASS * 1000, 
         ACTIVITY = ACTIVITY * 100) %>%
  mutate(SEX = factor(ifelse(SEX == "M", "males", "females")),
         SELECTION = factor(ifelse(SELECTION == "Mono", "M", "E")),
         `Sex and treatment` = factor(paste(SELECTION, SEX), c("M males", "E males", "M females", "E females"))) %>%
  mutate_if(is.numeric, ~ as.numeric(scale(.x))) %>%
  select(-SEX, -SELECTION) %>%
  rename(Cycle = CYCLE, Activity = ACTIVITY, `Body mass` = BODYMASS) %>% 
  select(VO2, VCO2, RQ, Activity, `Body mass`, `Sex and treatment`, Cycle) %>%
  ggpairs(aes(colour = `Sex and treatment`, fill = `Sex and treatment`),
          diag = list(continuous = wrap(modified_densityDiag, alpha = 0.7),
                      discrete = wrap("blank")),
          lower = list(continuous = wrap(modified_points, alpha = 0.7, size = 1.1), 
                       discrete = wrap("blank"),
                       combo = wrap(modified_box_no_facet, alpha = 0.7)),
          upper = list(continuous = wrap(modified_points, alpha = 0.7, size = 1.1),
                       discrete = wrap("blank"),
                       combo = wrap(modified_box_no_facet, alpha = 0.7, size = 0.5))) 

#respiration_pairs_plot %>% ggsave(filename = "figures/respiration_pairs_plot.pdf", height = 10, width = 10)
respiration_pairs_plot
```

**Figure XX:** Boxplots, scatterplots, and density plots illustrating the means, variances and covariances of the explanatory variables (`Treatment`, `Sex`, and `Cycle`) and the five response variables. The data are coloured by treatment (red: elevated polyandry, blue: monogamy). The plot shows the raw data in their original units, namely the number of mm of O$_2$ consumed or CO$_2$ produced, the % time spent active, and the body mass in milligrams; the respiratory quotient (RQ) is a unitless ratio (CO$_2$ produced / O$_2$ consumed). Note that the true value of RQ must lie within the range of 0.7-1.0 because of the chemistry of respiration, but estimates of RQ can lie outside this range due to sampling variance and measurement error for O$_2$ and CO$_2$. 

### Group means {.tabset}

#### Body weight (per triad)

```{r}
se <- function(x) sd(x) / sqrt(length(x))
respiration %>% 
  select(SEX, SELECTION, BODYMASS, SAMPLE) %>% 
  distinct(SAMPLE, .keep_all = TRUE) %>%
  group_by(SEX, SELECTION) %>% 
  summarise(`Mean weight per fly (mg)` = mean(BODYMASS * 1000 / 3), 
            SE = se(BODYMASS * 1000 / 3), 
            n = n()) %>% 
  kable(digits = 2) %>% kable_styling(full_width = FALSE)
```

#### Mean activity level

```{r}
respiration %>% 
  select(SEX, SELECTION, ACTIVITY, CYCLE, SAMPLE) %>%
  distinct(SAMPLE, CYCLE, .keep_all = TRUE) %>%
  group_by(SEX, SELECTION, CYCLE) %>% 
  summarise(`Mean activity level` = mean(ACTIVITY * 1000 / 3), 
            SE = se(ACTIVITY * 1000 / 3), 
            n = n()) %>% 
  kable(digits = 2) %>% kable_styling(full_width = FALSE)
```

#### Mean VO$_2$

```{r}
respiration %>% 
  select(SEX, SELECTION, VO2, CYCLE, SAMPLE) %>%
  distinct(SAMPLE, CYCLE, .keep_all = TRUE) %>% 
  group_by(SEX, SELECTION, CYCLE) %>% 
  summarise(`Mean VO2` = mean(VO2 * 1000), 
            SE = se(VO2 * 1000), 
            n = n()) %>% 
  kable(digits = 2) %>% kable_styling(full_width = FALSE)
```

#### Mean VCO$_2$

```{r}
respiration %>% 
  select(SEX, SELECTION, VCO2, CYCLE, SAMPLE) %>%
  distinct(SAMPLE, CYCLE, .keep_all = TRUE) %>%
  group_by(SEX, SELECTION, CYCLE) %>% 
  summarise(`Mean VCO2` = mean(VCO2 * 1000), 
            SE = se(VCO2 * 1000), 
            n = n()) %>% 
  kable(digits = 2) %>% kable_styling(full_width = FALSE)
```

#### Mean RQ

```{r}
respiration %>% 
  select(SEX, SELECTION, RQ, CYCLE, SAMPLE) %>%
  distinct(SAMPLE, CYCLE, .keep_all = TRUE) %>%
  group_by(SEX, SELECTION, CYCLE) %>% 
  summarise(`Mean RQ` = mean(RQ), 
            SE = se(RQ), 
            n = n()) %>% 
  kable(digits = 2) %>% kable_styling(full_width = FALSE)
```


## Draw the causal diagram

```{r}
DiagrammeR::grViz('digraph {

graph [layout = dot, rankdir = LR]

# define the global styles of the nodes. We can override these in box if we wish
node [shape = rectangle, style = filled, fillcolor = Linen]

"Metabolic\nrate" [shape = oval, fillcolor = Beige]
"Metabolic\nsubstrate" [shape = oval, fillcolor = Beige]
"Other factors\n(e.g. physiology)" [shape = oval, fillcolor = Beige]

# edge definitions with the node IDs
"Mating system\ntreatment (E vs. M)" -> {"Other factors\n(e.g. physiology)", "Body mass" , "Activity"} -> {"Metabolic\nrate", "Metabolic\nsubstrate"} 

{"Metabolic\nrate"} -> {"O\u2082 consumption", "CO\u2082 production"}
{"O\u2082 consumption", "CO\u2082 production"} -> "Respiratory\nquotient (RQ)"
{"Metabolic\nsubstrate"} -> "Respiratory\nquotient (RQ)"
}')
```
<br></br>
**Figure XX:** Directed acyclic graph (DAG) showing the key causal relationships that we hypothesised _a priori_ between the measured variables (squares) and latent variables (ovals). This DAG motivated the Bayesian structural equation model discussed in the Methods and Results, which attempts to decompose the effects of treatment on respiration (measured via O2 and CO2 flux, and their ratio, RQ) into paths that travel via body mass, activity, or other unmeasured factors such as physiology.


## Fit Bayesian structural equation model (SEM) via `brms`

### Scale the data

Here, we mean-center and scale body mass and activity. We also multiply `VO2` and `VCO2` by 1000, such that their units (and thus the associated regression coefficients) are not too small (and have means closer to those expected by the `brms` default intercept priors). 

The reason we do not mean-center and scale `VO2` and `VCO2` is that the model below relates them to each other in terms of the respiratory quotient, `RQ`, which would be more complex if they had been converted to standard deviations. 

```{r}
scaled_data <- respiration %>%
  mutate(VO2 = VO2 * 1000, 
         VCO2 = VCO2 * 1000,
         BODYMASS = as.numeric(scale(BODYMASS)),
         ACTIVITY = as.numeric(scale(ACTIVITY))) %>% 
  select(-RQ) 

scaled_data %>%
  mutate_if(is.numeric, ~ format(round(.x, 3), nsmall = 3)) %>%
  my_data_table()
```

### Define the SEM's sub-models

Here, we write out all the formulae of the sub-models in the SEM. There is a sub-model for oxygen consumption (`VO2`) and another for `CO2` production (`VCO2`) which depends on the parameter `RQ` (the respiratory quotient, i.e. `VCO2` / `VO2`); there are also sub-models for body mass (`BODYMASS`) and activity level (`ACTIVITY`).

In short, we assume that `VO2`, `RQ`, `BODYMASS`, and `ACTIVITY` are affected by the predictor variables related to the experimental design. These variables are `SELECTION` (i.e. M vs E treatment), `SEX` (Male or Female), `CYCLE` (I, II, or III: this refers to the first, second, and third measurement of O2 and CO2 for each triad of flies), `LINE` (8 levels, one for each of the four independent replicates of the M an P treatments), and `SAMPLE` (a random intercept that groups the three replicate measures of each triad of flies across the three cycles). Unlike the other response variables, `VCO2` is predicted from the estimated values of `VO2` and `RQ` as `VO2` \times `RQ`, and thus is related to the predictor variables only indirectly (the choice to make `VCO2` dependent rather than `VO2` dependant on `RQ` is arbitrary, and does not affect the results).

The `brms` notation for the line random effects (`(SELECTION | p | LINE)`) means that the model fits a random intercept for each of the 8 lines, and that these random intercepts are (potentially) correlated across each of the response variables. Furthermore, the model fits a random slope for `SELECTION`, which allows the treatment effect to vary across the replicate lines. 

#### VO2

Formula: `VO2 ~ SELECTION * SEX * CYCLE + BODYMASS + ACTIVITY + (SELECTION | p | LINE) + (1 | SAMPLE)`  
         
This formula allows for effects on `VO2` of sex, selection and cycle (and all 2- and 3-way interactions). The model also allows for linear effects of `BODYMASS` and `ACTIVITY` on `VO2`. Furthermore the model assumes there may be variation in `VO2` within and between each triad of flies, and between each replicate selection line (preventing pseudo-replication by properly accounting for our experimental design). 

#### VCO2 (as determined by the estimated parameter RQ) 

Formulae (2-part model, see `vignette("brms_nonlinear")`): 

`VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ))`

`RQ ~ SELECTION * SEX * CYCLE + BODYMASS + ACTIVITY + (SELECTION | p | LINE) + (1 | SAMPLE)`

`VCO2` is assumed to depend on the value of `VO2` from the same measurement, multiplied by `RQ`. We use a modified inverse logit function that forces `RQ` to lie 0.7 and 1 (this must be the case, given the chemistry of respiration, and building this information into the model should yield more precise estimates of the model's parameters). In turn, `RQ` is predicted by the same set of predictors as for `VO2`. 

#### Body mass

`BODYMASS | subset(body_subset) ~ SELECTION * SEX + (SELECTION | p | LINE)`  

The model fits the selection line treatment and sex as fixed effects, as well as the random intercept for line. There is not `SAMPLE` random effect, since the body mass of each triad of flies was measured only once (unlike for the other response variables, which were each measured 3 times). The notation `subset(body_subset)` instructs `brms` to fit this model using only a sub-set of the data, because unfortunately the body mass data was not collected for every triad of flies due to an experimental error (leaving our the `subset` term would discard all rows of the data for which body size was not measured, wasting the data for the other response variables).

#### Activity level

`ACTIVITY ~ SELECTION * SEX * CYCLE + (SELECTION | p | LINE) + (1 | SAMPLE)`  

The model fits the selection line treatment and sex as fixed effects, as well as crossed random intercepts for line and sample.


```{r}
brms_data <- scaled_data %>%
  mutate(body_subset = CYCLE == "I")    

brms_formula <- 
  bf(VO2 ~ SELECTION * SEX * CYCLE +  # VO2 sub-model
       BODYMASS + ACTIVITY +  
       (SELECTION | p | LINE) + (1 | SAMPLE)) +
  
  bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)),   # VCO2 and RQ sub-models
     RQ ~ SELECTION * SEX * CYCLE + 
       BODYMASS + ACTIVITY + 
       (SELECTION | p | LINE) + (1 | SAMPLE),
     nl = TRUE) +
  
  bf(BODYMASS | subset(body_subset) ~ SELECTION * SEX + # body mass sub-model
       (SELECTION | p | LINE)) +
  
  bf(ACTIVITY ~ SELECTION * SEX * CYCLE +   # activity sub-model
       (SELECTION | p | LINE) + (1 | SAMPLE)) +  
  
  set_rescor(FALSE) # cannot estimate residual correlations when using the subset() argument

brms_formula
```

### Define Priors
We set fairly tight Normal priors on all fixed effect parameters, which 'regularises' the estimates towards zero -- this is conservative (because it ensures that a stronger signal in the data is needed to produce a given posterior effect size estimate), and it also helps the model to converge. Similarly, we set a somewhat conservative half-Cauchy prior (mean 0, scale 0.1) on the random effects for `LINE` (i.e. we consider large differences between lines -- in terms of means and treatment effects -- to be possible but improbable). We leave all other priors at the defaults used by `brms`. Note that the Normal priors are slightly wider in the model of dry weight, because we expect larger effect sizes of sex and treatment on dry weight than on the metabolite composition. 

```{r}
prior_SEM <- c(set_prior("normal(0, 1)", class = "b", resp = 'VO2'),
            set_prior("normal(0, 1)", class = "b", resp = "VCO2", nlpar = "RQ"),
            set_prior("normal(0, 1)", class = "b", resp = "BODYMASS"),
            set_prior("normal(0, 1)", class = "b", resp = "ACTIVITY"),
            
            set_prior("cauchy(0, 0.1)", class = "sd", resp = 'VO2', group = "LINE"),
            set_prior("cauchy(0, 0.1)", class = "sd", resp = "VCO2", nlpar = "RQ", group = "LINE"),
            set_prior("cauchy(0, 0.1)", class = "sd", resp = 'VO2', group = "SAMPLE"),
            set_prior("cauchy(0, 0.1)", class = "sd", resp = "VCO2", nlpar = "RQ", group = "SAMPLE"),
            set_prior("cauchy(0, 0.1)", class = "sd", resp = 'BODYMASS', group = "LINE"),
            set_prior("cauchy(0, 0.1)", class = "sd", resp = 'ACTIVITY', group = "LINE"),
            set_prior("cauchy(0, 0.1)", class = "sd", resp = 'ACTIVITY', group = "SAMPLE"))

prior_SEM
```

### Run the model

The model is run over 4 chains with 7000 iterations each (with the first 3500 discarded as burn-in), for a total of 3500*4 = 14,000 posterior samples. 

```{r}
if(!file.exists("output/brms_SEM_respiration.rds")){
  brms_SEM_respiration <- brm(
    brms_formula, 
    data = brms_data, 
    iter = 7000, chains = 4, cores = 1,
    prior = prior_SEM,
    control = list(max_treedepth = 20, adapt_delta = 0.99))
  
  saveRDS(brms_SEM_respiration, "output/brms_SEM_respiration.rds")
} else brms_SEM_respiration <- readRDS("output/brms_SEM_respiration.rds")
```


### Posterior predictive check of model fit

The plot below shows that the fitted model is able to produce posterior predictions that have a similar distribution to the original data, for each of the response variables, which is a necessary condition for the model to be used for statistical inference. Note that the fit produces less accurate predictions for body mass, reflecting the smaller number of data points for this response variable.

```{r, fig.height=2, fig.width=5, message=F, warning=F}
grid.arrange(
  pp_check(brms_SEM_respiration, resp = "VO2") + 
    ggtitle("VO2") + theme(legend.position = "none"),
  pp_check(brms_SEM_respiration, resp = "VCO2") + 
    ggtitle("VCO2") + theme(legend.position = "none"),
  pp_check(brms_SEM_respiration, resp = "BODYMASS") + 
    ggtitle("Body mass") + theme(legend.position = "none"),
  pp_check(brms_SEM_respiration, resp = "ACTIVITY") + 
    ggtitle("Activity level") + theme(legend.position = "none"),
  nrow = 1
)
```


## Table of model parameter estimates {.tabset}

### Formatted table

This tables shows the fixed effects estimates for treatment, sex, their interaction, as well as the slope associated with dry weight (where relevant), for each of the response variables. The `p` column shows 1 - minus the "probability of direction", i.e. the posterior probability that the reported sign of the estimate is correct given the data and the prior; subtracting this value from one gives a Bayesian equivalent of a one-sided p-value. For brevity, we have omitted all the parameter estimates involving the predictor variable `line`, as well as the estimates of residual (co)variance. Click the next tab to see a complete summary of the model and its output.

```{r}
hypSEM <- left_join(
  fixef(brms_SEM_respiration) %>% as.data.frame() %>% rownames_to_column("Parameter"),
  bayestestR::p_direction(brms_SEM_respiration) %>% as.data.frame() %>% select(Parameter, pd) %>%
  mutate(Parameter = str_remove_all(Parameter, "b_"), Parameter = str_replace_all(Parameter, "[.]", ":")), 
  by = "Parameter"
) %>% mutate(Response = map_chr(str_split(Parameter, "_"), ~ .x[1]),
             Parameter = map(str_split(Parameter, "_"), ~ .x[length(.x)]),
             pd = 1 - pd) %>%
  select(Response, Parameter, everything()) %>% 
  rename(p = pd) %>%
  mutate(Parameter = str_replace_all(Parameter, "SELECTIONPoly", "Treatment (E)"),
         Parameter = str_replace_all(Parameter, "SEXM", "Sex (M)"),
         Parameter = str_replace_all(Parameter, "BODYMASS", "Body weight"),
         Parameter = str_replace_all(Parameter, "ACTIVITY", "Activity level"),
         Parameter = str_replace_all(Parameter, "CYCLEIII", "Cycle (III)"),
         Parameter = str_replace_all(Parameter, "CYCLEII", "Cycle (II)"),
         Parameter = str_replace_all(Parameter, ":", " x ")) %>%
  mutate(Response = str_replace_all(Response, "BODYMASS", "Body weight"),
         Response = str_replace_all(Response, "ACTIVITY", "Activity level"),
         Response = str_replace_all(Response, "VCO2", "Respiratory quotient (RQ)"),
         Response = factor(Response, c("VO2", "Respiratory quotient (RQ)", "Activity level", "Body weight"))) %>%
  mutate(` ` = ifelse(p < 0.05, "\\*", "")) %>%
  distinct() %>%
  arrange(Response) %>%
  select(-Response)

hypSEM  %>% 
  kable(digits = 3) %>% 
  kable_styling(full_width = FALSE) %>%
  group_rows("Oxygen consumption (VO2)", 1, 14) %>%
  group_rows("Respiratory quotient (RQ)", 15, 28) %>%
  group_rows("Activity level", 29, 40) %>%
  group_rows("Body weight", 41, 44) 
```

### Complete output from `summary.brmsfit()`

- 'Group-Level Effects' (also called random effects): This shows the (co)variances associated with the line-specific intercepts (which have names like `sd(VO2_Intercept)`) and slopes (e.g. `sd(VO2_SELECTIONPoly)`), as well as the correlations between these effects (e.g. `cor(VO2_Intercept,VO2_SELECTIONPoly)`.
- 'Population-Level Effects:' (also called fixed effects): These give the estimates of the intercept (i.e. for female M flies, in Cycle I) and the effects of treatment, sex, dry weight, and the various interaction terms, for each response variable.
- 'Family Specific Parameters': This is the parameter sigma for the residual variance for each response variable

Note that the model has converged (Rhat = 1) and the posterior is adequately samples (high ESS values).

```{r max.height='30px'}
brms_SEM_respiration
```


## Posterior estimates of the effect size

Here, we calculate the effect size of the selection treatment on each response variable (and `RQ`) from the posterior estimates of the SEM.

### Derive posterior predictions of group means

Here, we use the model to predict the means for each response variable (and the parameter `RQ`) in each treatment, sex and cycle (averaged across the eight replicate selection lines). 

Because the model contains body mass and activity level as mediator variables, we derived the posterior predictions in three different ways, and display the answer for all three in the following figures/tables. 

First, we predicted the posterior means without controlling for either of the mediator variables, by deriving our predictions for each cycle, sex, and treatment with `BODYMASS` and `ACTIVITY` set to their estimated mean values for that specific cycle/sex/treatment combination. This means that (for example) if activity level positively affects respiration, and E flies evolved higher activity levels, we would predict higher VO2 in E flies due to their larger activity levels. 

Second, we predicted the posterior means while controlling for differences in activity level between cycles, sexes, and treatments. This was accomplished by producing the posterior predictions with `ACTIVITY` set to its global mean value (i.e. 0), which is equivalent to asking what the response variables would be if activity levels were the same across cycles, sexes, and treatments.

Third, we predicted the posterior means while controlling for differences in body mass between sexes and treatment. This was accomplished by producing the posterior predictions with `BODYMASS` set to its global mean value (i.e. 0), which is equivalent to asking what the response variables would be if body mass were the same across sexes and treatments.

```{r}
new <- scaled_data %>%
  select(SELECTION, SEX, CYCLE) %>%
  distinct() %>%
  mutate(body_subset = TRUE)

# Find the posterior estimates of the means for the mediator variables:
bodymass_posterior <- brms_SEM_respiration %>%
  fitted(newdata = new, re_formula = NA,
         resp = "BODYMASS", summary = FALSE) %>% 
  reshape2::melt() %>%
  rename(draw = Var1, parameter_space = Var2, `Body mass` = value) %>%
  left_join(new %>% mutate(parameter_space = 1:n()), by = "parameter_space") %>%
  select(draw, SELECTION, SEX, `Body mass`) %>% as_tibble() %>% distinct() %>%
  mutate(
    treat = ifelse(SELECTION == "Mono", "M", "E"), 
    sex = ifelse(SEX == "F", "females", "males"), 
    sextreat = paste(treat, sex),
    SEX = factor(ifelse(SEX == "F", "Females", "Males"), c("Males", "Females")),
    SELECTION = ifelse(SELECTION == "Poly", "Polyandry", "Monandry")) 

activity_posterior <- brms_SEM_respiration %>%
  fitted(newdata = new, re_formula = NA,
         resp = "ACTIVITY", summary = FALSE) %>% 
  reshape2::melt() %>%
  rename(draw = Var1, parameter_space = Var2, `Activity level` = value) %>%
  left_join(new %>% mutate(parameter_space = 1:n()), by = "parameter_space") %>%
  select(draw, SELECTION, SEX, CYCLE, `Activity level`) %>% as_tibble() %>%
  mutate(
    treat = ifelse(SELECTION == "Mono", "M", "E"), 
    sex = ifelse(SEX == "F", "females", "males"), 
    sextreat = paste(treat, sex),
    SEX = factor(ifelse(SEX == "F", "Females", "Males"), c("Males", "Females")),
    SELECTION = ifelse(SELECTION == "Poly", "Polyandry", "Monandry")) 


# Get the median posterior estimate of body weight and activity,
# for the 4 combinations of sex and monogamy/polyandry treatment (and 3 cycles, for activity)
bodymass <- brms_SEM_respiration %>%
  fitted(newdata = new, re_formula = NA,
         resp = "BODYMASS") %>% as_tibble()

activity <- brms_SEM_respiration %>%
  fitted(newdata = new, re_formula = NA,
         resp = "ACTIVITY") %>% as_tibble()

new_mediators <- new %>%
  mutate(BODYMASS = bodymass$Estimate,
         ACTIVITY = activity$Estimate)

new_complete <- bind_rows(
  new_mediators %>% mutate(mediators_blocked = "Neither"),
  new_mediators %>% mutate(mediators_blocked = "Activity", 
                 ACTIVITY = 0),
  new_mediators %>% mutate(mediators_blocked = "Body mass",
                 BODYMASS = 0)) %>%
  mutate(VO2 = NA, parameter_space = 1:n()) 

post_preds_respiration <- left_join(
  brms_SEM_respiration %>%
    fitted(newdata = new_complete, re_formula = NA,
           resp = "VO2", summary = FALSE) %>% reshape2::melt() %>% 
    rename(draw = Var1, parameter_space = Var2, VO2 = value) %>%
    left_join(new_complete %>% select(-VO2), by = "parameter_space") %>% 
    as_tibble(),
  
  brms_SEM_respiration %>%
    fitted(newdata = new_complete, re_formula = NA,
           resp = "VCO2", nlpar = "RQ", summary = FALSE) %>% reshape2::melt() %>% 
    rename(draw = Var1, parameter_space = Var2, RQ = value) %>%
    left_join(new_complete %>% select(-VO2), by = "parameter_space") %>% 
    as_tibble() %>%
    mutate(RQ = 0.7 + 0.3 * inv_logit(RQ)), 
  by = c("draw", "parameter_space", "SELECTION", "SEX", "CYCLE", 
         "body_subset", "BODYMASS", "ACTIVITY", "mediators_blocked")
) %>% select(draw, VO2, RQ, SELECTION, SEX, CYCLE, mediators_blocked)
```

### Find posterior estimates of effect size {.tabset}
We then calculate the effect size of treatment by subtracting the (sex-specific) mean for the M treatment from the mean for the E treatment; thus a value of 1 would mean that the E treatment has a mean that is larger by 1 standard deviation. Thus, the y-axis in the following graphs essentially shows the posterior estimate of standardised effect size (Cohen's d), from the model shown above. 

```{r}
overall_SD_VO2 <- scaled_data$VO2 %>% sd()
overall_SD_RQ <- respiration$RQ %>% sd()

posterior_effect_size <- post_preds_respiration %>%
  mutate(mediators_blocked = factor(mediators_blocked, c("Neither", "Body mass", "Activity"))) %>%
  mutate(SEX = factor(ifelse(SEX == "M", "Males", "Females"), c("Males", "Females"))) %>%
  mutate(CYCLE = paste("Cycle", CYCLE)) %>%
  group_by(draw, SEX, CYCLE, mediators_blocked) %>%
  summarise(VO2_effect = (VO2[SELECTION == "Poly"] - VO2[SELECTION == "Mono"]) / overall_SD_VO2,
            RQ_effect = (RQ[SELECTION == "Poly"] - RQ[SELECTION == "Mono"]) / overall_SD_RQ,
            .groups = "drop") 
```

#### Figure

Note that the females are larger than males, and that E females are somewhat larger than M females. E individuals of both sexes are more active than M individuals, and there are changes in activity level across cycles (in particular, M males become less active with time, while E males maintain consistent, high activity levels).

```{r fig.height=7.5, fig.width=5, fig.showtext=TRUE}
p1 <- arrangeGrob(
  
  bodymass_posterior %>%
    mutate(CYCLE = "All cycles") %>%
    ggplot(aes(y = SELECTION, x = `Body mass`, fill = sextreat)) + 
    geom_vline(xintercept = 0, linetype = 2, colour = "grey20") + 
    geom_halfeyeh(alpha = 0.7, size = 0.6) +
    facet_grid(SEX ~ CYCLE) +
    coord_cartesian(xlim = c(-1.9, 1.9)) + 
    scale_fill_manual(values = cols, name = "") + 
    theme_bw() + 
    theme(legend.position = "none",
          strip.text.y = element_text(colour = "white"),
          text = element_text(family = nice_font),
          strip.background = element_rect(fill = "white", colour = "white")) + 
    ylab(NULL),
  
  activity_posterior %>%
    mutate(CYCLE = paste("Cycle", CYCLE)) %>%
    ggplot(aes(y = SELECTION, x = `Activity level`, fill = sextreat)) + 
    geom_vline(xintercept = 0, linetype = 2, colour = "grey20") + 
    stat_halfeye(alpha = 0.7, size = 0.6) + 
    facet_grid(SEX ~ CYCLE) +
    scale_fill_manual(values = cols, name = "") + 
    theme_bw() + 
    coord_cartesian(xlim = c(-1.5, 1.7)) + 
    theme(legend.position = "none", 
          axis.text.y = element_blank(), 
          text = element_text(family = nice_font),
          strip.background = element_blank(),
          axis.ticks.y = element_blank()) + ylab(NULL),
  nrow = 1, widths = c(0.38, 0.62), 
  left = textGrob("Selection treatment", rot = 90, gp=gpar(fontfamily = nice_font)),
  top = textGrob("A. Mediator variables (means)", hjust = 1, gp=gpar(fontfamily = nice_font)) 
)

p2 <- arrangeGrob(
  posterior_effect_size %>% 
    ggplot(aes(y = mediators_blocked, 
               x = VO2_effect,
               fill = mediators_blocked)) + 
    geom_vline(xintercept = 0, linetype = 2) + 
    stat_halfeye(size = 0.5, alpha = 0.5) + 
    facet_grid(SEX ~ CYCLE) +
    xlab(expression(VO[2]~(E~-~M))) + 
    ylab(NULL)  +
    scale_fill_brewer(palette = "Set2") + 
    theme_bw() +
    coord_cartesian(xlim = c(-0.6, 1.9)) + 
    theme(legend.position = "none",
          text = element_text(family = nice_font),
          strip.background = element_blank()),
  
  posterior_effect_size %>% 
    ggplot(aes(y = mediators_blocked, 
               x = RQ_effect,
               fill = mediators_blocked)) + 
    geom_vline(xintercept = 0, linetype = 2) + 
    stat_halfeye(size = 0.5, alpha = 0.5) + 
    facet_grid(SEX ~ CYCLE) +
    xlab("RQ (E - M)") + 
    ylab(NULL)  +
    scale_fill_brewer(palette = "Set2") + 
    theme_bw() +
    scale_x_continuous(breaks = c(-1, 0, 1)) +
    coord_cartesian(xlim = c(-1.1, 1.5)) + 
    theme(legend.position = "none",
          text = element_text(family = nice_font),
          strip.background = element_blank()),
  ncol = 1, 
  left = textGrob("Mediator variables controlled for", rot = 90, gp=gpar(fontfamily = nice_font)),
  top = textGrob("B. Respiration (effect sizes)", hjust = 1, gp=gpar(fontfamily = nice_font)) 
)

p_filler <- ggplot() + theme_void()

grid.arrange(p1, 
             arrangeGrob(p_filler, p2, p_filler, 
                         nrow = 1, widths = c(0.1, 0.8, 0.1)), 
             heights = c(0.35, 0.65)) 

# grid.arrange(p1, 
#              arrangeGrob(p_filler, p2, p_filler, 
#                          nrow = 1, widths = c(0.1, 0.8, 0.1)), 
#              heights = c(0.35, 0.65)) %>% 
#   ggsave("figures/respiration_figure.pdf", plot = ., height = 8, width = 5)


# omit RQ
p3 <- arrangeGrob(
  posterior_effect_size %>% 
    ggplot(aes(y = mediators_blocked, 
               x = VO2_effect,
               fill = mediators_blocked)) + 
    geom_vline(xintercept = 0, linetype = 2) + 
    stat_halfeye(size = 0.5, alpha = 0.5) + 
    facet_grid(SEX ~ CYCLE) +
    xlab(expression(VO[2]~(E~-~M))) + 
    ylab(NULL)  +
    scale_fill_brewer(palette = "Set2") + 
    theme_bw() +
    coord_cartesian(xlim = c(-0.6, 1.9)) + 
    theme(legend.position = "none",
          text = element_text(family = nice_font),
          strip.background = element_blank()), 
  left = textGrob("Mediator variables controlled for", rot = 90, gp=gpar(fontfamily = nice_font)),
  top = textGrob("B. Metabolic rate (effect sizes)", hjust = 1, gp=gpar(fontfamily = nice_font))
)

# grid.arrange(p1,
#              arrangeGrob(p_filler, p3, p_filler,
#                          nrow = 1, widths = c(0.1, 0.8, 0.1)),
#              heights = c(0.35, 0.65)) %>%
#   ggsave("figures/respiration_figure_noRQ.pdf", plot = ., height = 5, width = 5)

```


#### Tables

##### Posterior estimates of the mean for mediator variables

```{r}
bodymass_posterior %>%
  mutate(CYCLE = "All cycles") %>%
  select(SELECTION, SEX, CYCLE, `Body mass`, draw) %>% 
  group_by(SELECTION, SEX, CYCLE) %>%
  summarise(x = list(posterior_summary(`Body mass`) %>% 
                        as.data.frame()), .groups = "drop") %>%
  unnest(x) %>% mutate(Response = "Body weight (mean)") %>%
  bind_rows(
activity_posterior %>%
  select(SELECTION, SEX, CYCLE, `Activity level`, draw) %>%
  group_by(SELECTION, SEX, CYCLE) %>%
  summarise(x = list(posterior_summary(`Activity level`) %>% 
                        as.data.frame()), .groups = "drop") %>%
  unnest(x) %>% mutate(Response = "Activity level (mean)")) %>%
  rename(Selection = SELECTION, Sex = SEX, Cycle = CYCLE) %>%
  select(-Response) %>%
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE) %>%
  pack_rows("Body weight (mean)", 1, 4) %>%
  pack_rows("Activity level (mean)", 5, 16)
```


##### Posterior estimates of the effect size for VO$_2$ and RQ

```{r}
posterior_effect_size %>%
  select(mediators_blocked, SEX, CYCLE, VO2_effect, draw) %>%
  group_by(mediators_blocked, SEX, CYCLE) %>%
  summarise(x = list(posterior_summary(VO2_effect) %>% 
                        as.data.frame()),
            p = 1 - as.numeric(bayestestR::p_direction(VO2_effect)),
            ` ` = ifelse(p < 0.05, "\\*", ""),
            .groups = "drop") %>%
  unnest(x) %>% mutate(Response = "VO2 effect size") %>%
  bind_rows(
    posterior_effect_size %>%
      select(mediators_blocked, SEX, CYCLE, RQ_effect, draw) %>%
      group_by(mediators_blocked, SEX, CYCLE) %>%
       summarise(x = list(posterior_summary(RQ_effect) %>% 
                        as.data.frame()),
            p = 1 - as.numeric(bayestestR::p_direction(RQ_effect)),
            ` ` = ifelse(p < 0.05, "\\*", ""),
            .groups = "drop") %>%
      unnest(x) %>% mutate(Response = "RQ effect size")) %>%
  select(-Response) %>% rename(`Mediators blocked` = mediators_blocked, Sex = SEX, Cycle = CYCLE) %>%
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE) %>%
  pack_rows("VO2 effect size", 1, 18) %>%
  pack_rows("RQ effect size", 19, 36)
```


## Posterior difference in treatment effect size between sexes 

This section essentially examines the treatment $\times$ sex interaction term, by calculating the difference in the effect size of the E/M treatment between sexes, for each cycle, for VO$_2$. We find that the effect of the E/M treatment on VO$_2$ is greater in males than females, but only in the final cycle. Statistically correcting for differences in activity between sexes and treatments partly attenuated this effect, which suggests that the greater effect of treatment on activity in males is what explains the greater effect of treatment on VO2 in males.

### Figure {.tabset}

```{r}
treatsex_interaction <- posterior_effect_size %>%
  rename(Cycle = CYCLE) %>%
  group_by(draw, Cycle, mediators_blocked) %>%
  summarise(`Difference in effect size between sexes (male - female)` = VO2_effect[1] - VO2_effect[2],
            .groups = "drop")

treatsex_interaction %>%
  ggplot(aes(x = `Difference in effect size between sexes (male - female)`, y = 1, fill = stat(x < 0))) +
  geom_vline(xintercept = 0, linetype = 2) +
  stat_halfeye() +
  facet_grid(mediators_blocked ~ Cycle) +
  scale_fill_brewer(palette = 'Pastel2', direction = 1, name = "") +
  theme_bw() +
  theme(legend.position = 'none',
        text = element_text(family = nice_font),
        strip.background = element_blank()) +
  ylab("Posterior density")
```


### Table {.tabset}

```{r}
treatsex_interaction %>%
  rename(x = `Difference in effect size between sexes (male - female)`) %>%
  group_by(Cycle, mediators_blocked) %>%
  summarise(`Difference in effect size between sexes (male - female)` = median(x),
            `Lower 95% CI` = quantile(x, probs = 0.025), 
            `Upper 95% CI` = quantile(x, probs = 0.975),
            p = 1 - as.numeric(bayestestR::p_direction(x)),
            ` ` = ifelse(p < 0.05, "\\*", ""),
            .groups = "drop") %>%
  kable(digits=3) %>%
  kable_styling(full_width = FALSE)
```




