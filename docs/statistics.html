<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Statistical analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="site_libs/viz-1.8.2/viz.js"></script>
<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="site_libs/grViz-binding-1.0.5/grViz.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">respiration_exp_evolution</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Statistical analysis</h1>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2020-03-03
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 6 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 1
</p>
<p>
<strong>Knit directory:</strong> <code>respiration_exp_evolution/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.0). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguncommittedchanges"> <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> <strong>R Markdown file:</strong> uncommitted changes </a>
</p>
</div>
<div id="strongRMarkdownfilestronguncommittedchanges" class="panel-collapse collapse">
<div class="panel-body">
<p>The R Markdown file has unstaged changes. To know which version of the R Markdown file created these results, you’ll want to first commit it to the Git repo. If you’re still working on the analysis, you can ignore this warning. When you’re finished, you can run <code>wflow_publish</code> to commit the R Markdown file and build the HTML.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20190703code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20190703)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20190703code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20190703)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomlukeholmanexpevolrespirationtree27523526d153b1705871bfc150cb04416f53af88targetblank2752352a"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/lukeholman/exp_evol_respiration/tree/27523526d153b1705871bfc150cb04416f53af88" target="_blank">2752352</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomlukeholmanexpevolrespirationtree27523526d153b1705871bfc150cb04416f53af88targetblank2752352a" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    data/.DS_Store

Untracked files:
    Untracked:  Supplementary tables and figures.docx
    Untracked:  data/model_selection_table.rds
    Untracked:  data/top_model_files.rds
    Untracked:  manuscript.docx
    Untracked:  output/temp_files/
    Untracked:  ~$nuscript.docx

Unstaged changes:
    Modified:   .Rprofile
    Modified:   .gitignore
    Modified:   analysis/statistics.Rmd
    Modified:   output/Figure 2.pdf
    Modified:   output/brms_SEM.rds

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the R Markdown and HTML files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view them.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/lukeholman/exp_evol_respiration/blob/27523526d153b1705871bfc150cb04416f53af88/analysis/statistics.Rmd" target="_blank">2752352</a>
</td>
<td>
lukeholman
</td>
<td>
2020-01-17
</td>
<td>
Almost reaedy
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/exp_evol_respiration/27523526d153b1705871bfc150cb04416f53af88/docs/statistics.html" target="_blank">2752352</a>
</td>
<td>
lukeholman
</td>
<td>
2020-01-17
</td>
<td>
Almost reaedy
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="load-r-packages" class="section level2">
<h2>Load R packages</h2>
<pre class="r"><code>library(tidyverse)
library(gridExtra)
library(brms)
library(RColorBrewer)
library(glue)
library(kableExtra)
library(tidybayes)
library(bayestestR)
library(MuMIn)
library(glue)
library(ggridges)
library(future)
library(future.apply)
options(stringsAsFactors = FALSE)</code></pre>
</div>
<div id="load-respirometry-data" class="section level2">
<h2>Load respirometry data</h2>
<pre class="r"><code>respiration &lt;- read_csv(&quot;data/2.metabolic_rates.csv&quot;) %&gt;%
  rename(SELECTION = `?SELECTION`)</code></pre>
</div>
<div id="draw-the-flow-diagram" class="section level2">
<h2>Draw the flow diagram</h2>
<pre class="r"><code>DiagrammeR::grViz(&#39;digraph {

graph [layout = dot, rankdir = LR]

# define the global styles of the nodes. We can override these in box if we wish
node [shape = rectangle, style = filled, fillcolor = Linen]

&quot;Metabolic\nrate&quot; [shape = oval, fillcolor = Beige]
&quot;Metabolic\nsubstrate&quot; [shape = oval, fillcolor = Beige]
&quot;Other factors\n(e.g. physiology)&quot; [shape = oval, fillcolor = Beige]

# edge definitions with the node IDs
&quot;Mating system\ntreatment (M vs P)&quot; -&gt; {&quot;Other factors\n(e.g. physiology)&quot;, &quot;Body mass&quot; , &quot;Activity&quot;} -&gt; {&quot;Metabolic\nrate&quot;, &quot;Metabolic\nsubstrate&quot;} 

{&quot;Metabolic\nrate&quot;} -&gt; &quot;Oxygen\nconsumption&quot;
{&quot;Metabolic\nsubstrate&quot;} -&gt; &quot;Respiratory\nquotient (RQ)&quot;
}&#39;)</code></pre>
<p><div id="htmlwidget-6ec5e240e3b68e9cc473" style="width:672px;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-6ec5e240e3b68e9cc473">{"x":{"diagram":"digraph {\n\ngraph [layout = dot, rankdir = LR]\n\n# define the global styles of the nodes. We can override these in box if we wish\nnode [shape = rectangle, style = filled, fillcolor = Linen]\n\n\"Metabolic\nrate\" [shape = oval, fillcolor = Beige]\n\"Metabolic\nsubstrate\" [shape = oval, fillcolor = Beige]\n\"Other factors\n(e.g. physiology)\" [shape = oval, fillcolor = Beige]\n\n# edge definitions with the node IDs\n\"Mating system\ntreatment (M vs P)\" -> {\"Other factors\n(e.g. physiology)\", \"Body mass\" , \"Activity\"} -> {\"Metabolic\nrate\", \"Metabolic\nsubstrate\"} \n\n{\"Metabolic\nrate\"} -> \"Oxygen\nconsumption\"\n{\"Metabolic\nsubstrate\"} -> \"Respiratory\nquotient (RQ)\"\n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script> <br></br> <strong>Figure 1:</strong> Directed acyclic graph (DAG) showing the key causal relationships that we hypothesised a priori between the measured variables (squares) and latent variables (ovals). This DAG motivated the Bayesian structural equation model discussed in the Methods and Results, which attempts to decompose the effects of treatment on respiration (measured via O2 and CO2 flux, and their ratio, RQ) into paths that travel via body mass, activity, or other unmeasured factors such as physiology.</p>
</div>
<div id="inspecting-the-raw-data" class="section level2">
<h2>Inspecting the raw data</h2>
<div id="selection-treatment-has-affected-activity-and-body-size" class="section level3">
<h3>Selection treatment has affected activity and body size</h3>
<p>There is a strong effect of selection treatment on activity in both sexes, and an effect of selection on female body size.</p>
<pre class="r"><code>respiration %&gt;%
  filter(CYCLE == &quot;I&quot;) %&gt;%
  mutate(`Body weight` = scale(BODY_WEIGHT),
         `Activity level` = scale(ACTIVITY)) %&gt;%
  gather(trait, value, `Body weight`, `Activity level`) %&gt;%
  ggplot(aes(SEX, value, colour = SELECTION)) + 
  stat_summary(position = position_dodge(0.4), size = 0.3) + 
  facet_wrap(~ trait) + 
  scale_color_brewer(palette = &quot;Set1&quot;, direction = -1)</code></pre>
<p><img src="figure/statistics.Rmd/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-4-1">
Past versions of unnamed-chunk-4-1.png
</button>
</p>
<div id="fig-unnamed-chunk-4-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/lukeholman/exp_evol_respiration/blob/27523526d153b1705871bfc150cb04416f53af88/docs/figure/statistics.Rmd/unnamed-chunk-4-1.png" target="_blank">2752352</a>
</td>
<td>
lukeholman
</td>
<td>
2020-01-17
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="fit-the-first-brms-models-ignoring-the-moderator-variables" class="section level2">
<h2>Fit the first <code>brms</code> models, ignoring the moderator variables</h2>
<div id="scale-the-input-data" class="section level3">
<h3>Scale the input data</h3>
<p>Here, we scale and centre the body mass (across all samples), and multiply VO2 and VCO2 by 1000 so that their units (and resulting regression coefficients) are close to those assumed by the <code>brms</code> default priors.</p>
<p>We did not scale and centre VO2 and VCO2, because we will soon relate them to each other via the respiratory quotient, RQ, so it makes sense to leave them in their original units rather than converting their units to standard deviations. We also did not scale and centre activity level, because this variable is naturally bounded by zero and one, and so one can model it on its original scale using the <a href="https://en.wikipedia.org/wiki/Beta_distribution">beta distribution</a>.</p>
<p>Note that body mass and activity are not actually used until the following section (i.e. <em>Fit the <code>brms</code> structural equation model (SEM)</em>).</p>
<pre class="r"><code>scaled_data &lt;- respiration %&gt;%
  mutate(VO2 = VO2 * 1000, 
         VCO2 = VCO2 * 1000,
         BODY_WEIGHT = as.numeric(scale(BODY_WEIGHT))) %&gt;% 
  rename(BODYMASS = BODY_WEIGHT)</code></pre>
</div>
<div id="write-out-the-full-models-formulae" class="section level3">
<h3>Write out the full model’s formulae</h3>
<p>Here, I write out all the formulae for the “full model”, as well as their equivalents for all the simpler models nested within the full model. All of these models contain more than one formula each (i.e. they are multivariate models): one formula for oxygen consumption (VO2) and one for CO2 production (VCO2), as well as a formula for the parameter RQ (the respiratory quotient, i.e. VCO2 / VO2). I assume that VO2 and RQ are both affected by the predictor variables that resukt from the experimental design, namely SELECTION (i.e. M vs P treatment), SEX (Male or Female), CYCLE (I, II, or III: this refers to the first, second, and third measurement of O2 and CO2 for each triad of flies), LINE (a random intercept term with 8 levels, one for each of the four independent replicates of the M an P treatmens), and SAMPLE (which identifies the three replicate measures of each triad of flies across the three cycles). The formulae for VO2 and VCO2 are as follows:</p>
<div id="vo2" class="section level4">
<h4>VO2</h4>
<p>Formula: <code>VO2 ~ SELECTION * SEX * CYCLE + (1 | LINE) + (1 | SAMPLE)</code></p>
<p>This formula allows for effects on VO2 of sex, selection and cycle (and all 2- and 3-way interactions), and models the variation in VO2 within and between each triad of flies and each replicate selection line (preventing pseudo-replication by properly accounting for our experimental design).</p>
</div>
<div id="vco2-as-determined-by-the-parameter-rq" class="section level4">
<h4>VCO2 (as determined by the parameter RQ)</h4>
<p>Formulae (2-part model, see <code>vignette(&quot;brms_nonlinear&quot;)</code>):</p>
<p><code>VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ))</code></p>
<p><code>RQ ~ SELECTION * SEX * CYCLE + (1 | LINE) + (1 | SAMPLE)</code></p>
<p>VCO2 is assumed to depend on the value of VO2 from the same measurement, multiplied by RQ, a parameter that is constrained to vary between 0.7 and 1 (based on our prior knowledge of the chemistry of respiration) through the use of the inverse logit function. In turn, RQ is assumed to depend on the same set of predictors as for VO2.</p>
</div>
<div id="priors" class="section level4">
<h4>Priors</h4>
<p>To apply some mild regularisation and assist model convergence, we set a prior on all the fixed effect parameters of <code>normal(0, 3)</code>.</p>
</div>
<div id="family" class="section level4">
<h4>Family</h4>
<p>All response variables are assumed to follow a normal (Gaussian) distribution.</p>
</div>
</div>
<div id="finding-all-the-sub-models-for-model-selection" class="section level3">
<h3>Finding all the sub-models for model selection</h3>
<p>Now that we have written out the full model, we can find all its component sub-models. This is complicated by the fact that it is a multivariate model, and so we need to find the sub-models for both VO2 and RQ, and then find all possible combinations of these.</p>
<pre class="r"><code># For convenience, we borrow the function `dredge()` from the MuMIn package, 
# and use it find all submodels
all_sub_models &lt;- paste(get.models(with(options(na.action = na.fail), 
                      dredge(lm(VO2 ~ SELECTION * SEX * CYCLE, data = scaled_data))), subset = TRUE) %&gt;%
  map_chr(~ as.character(.x$call)[2]) %&gt;% 
    unname() %&gt;% 
    str_remove_all(&quot; [+] 1&quot;) %&gt;% 
    str_remove_all(&quot;VO2 ~ &quot;), 
  &quot;+ (1 | LINE) + (1 | SAMPLE)&quot;) 

# Find all combinations of sub-model formulas for VO2 and RQ
combos &lt;- expand.grid(vo2 = all_sub_models, 
                      rq = all_sub_models, stringsAsFactors = FALSE)

# Write out the complete multi-part formulas for all 361 to be compared
write_formula &lt;- function(vo2, rq){
glue(&quot;
bf(VO2 ~ {vo2}) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ {rq}, nl = TRUE) + set_rescor(FALSE)&quot;) %&gt;% 
    as.character()
}

all_formulas &lt;- map2(combos[,1], 
                     combos[,2], 
                     write_formula)

print(&quot;Inspect the first few formulas:&quot;)</code></pre>
<pre><code>[1] &quot;Inspect the first few formulas:&quot;</code></pre>
<pre class="r"><code>kable(head(unlist(all_formulas)))</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
x
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
bf(VO2 ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE)) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE), nl = TRUE) + set_rescor(FALSE)
</td>
</tr>
<tr>
<td style="text-align:left;">
bf(VO2 ~ CYCLE + SELECTION + SEX + (1 | LINE) + (1 | SAMPLE)) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE), nl = TRUE) + set_rescor(FALSE)
</td>
</tr>
<tr>
<td style="text-align:left;">
bf(VO2 ~ CYCLE + SELECTION + SEX + CYCLE:SELECTION + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE)) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE), nl = TRUE) + set_rescor(FALSE)
</td>
</tr>
<tr>
<td style="text-align:left;">
bf(VO2 ~ CYCLE + SELECTION + SEX + CYCLE:SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE)) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE), nl = TRUE) + set_rescor(FALSE)
</td>
</tr>
<tr>
<td style="text-align:left;">
bf(VO2 ~ CYCLE + SELECTION + SEX + CYCLE:SELECTION + (1 | LINE) + (1 | SAMPLE)) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE), nl = TRUE) + set_rescor(FALSE)
</td>
</tr>
<tr>
<td style="text-align:left;">
bf(VO2 ~ CYCLE + SELECTION + SEX + CYCLE:SEX + (1 | LINE) + (1 | SAMPLE)) + bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)), RQ ~ CYCLE + SELECTION + SEX + SELECTION:SEX + (1 | LINE) + (1 | SAMPLE), nl = TRUE) + set_rescor(FALSE)
</td>
</tr>
</tbody>
</table>
</div>
<div id="run-all-the-brms-models-and-save-them-to-disk" class="section level3">
<h3>Run all the <code>brms</code> models and save them to disk</h3>
<p>Here, we run all 361 of the models whose formulae are given in the vector <code>all_formulas</code>, and save the results of each model to an external hard drive (this uses about 55GB). Note that the prior for each model is the same, except that one does not need to specify a prior on the fixed effects in models that do not contain any fixed effects, which is why the <code>if()</code> statements are needed.</p>
<pre class="r"><code># Define function for the inverse logit
inv_logit &lt;- function(x) 1 / (1 + exp(-x))

# Function to run a model using formula number &quot;i&quot; in &quot;formula_list&quot; on dataframe &quot;my_data&quot;
run_model &lt;- function(i, formula_list, my_data){
  
  save_location &lt;- &quot;/Volumes/LACIE_SHARE/brms_respiration&quot;
  num &lt;- str_pad(i, 3, pad = &quot;0&quot;)
  file_name &lt;- glue(&quot;{save_location}/model_{num}.rds&quot;)
  if(file.exists(file_name)) return(NULL)
  
  focal_formula &lt;- eval(parse(text = formula_list[[i]]))
  
  if(!str_detect(focal_formula, &quot;VO2 ~ 1&quot;) &amp; !str_detect(focal_formula, &quot;RQ ~ 1&quot;)){
    model &lt;- brm(focal_formula, 
                 data = my_data, 
                 iter = 10000, chains = 4, cores = 1,
                 prior = c(prior(normal(0, 3), class = &quot;b&quot;, resp = &quot;VO2&quot;),
                           prior(normal(0, 3), class = &quot;b&quot;, resp = &quot;VCO2&quot;, nlpar = &quot;RQ&quot;)),
                 control = list(max_treedepth = 20, adapt_delta = 0.99),
                 save_all_pars = TRUE)
  } 
  if(!str_detect(focal_formula, &quot;VO2 ~ 1&quot;) &amp; str_detect(focal_formula, &quot;RQ ~ 1&quot;)){
    model &lt;- brm(focal_formula, 
                 data = my_data, 
                 iter = 10000, chains = 4, cores = 1,
                 prior = prior(normal(0, 3), class = &quot;b&quot;, resp = &quot;VO2&quot;),
                 control = list(max_treedepth = 20, adapt_delta = 0.99),
                 save_all_pars = TRUE)
  }
  if(str_detect(focal_formula, &quot;VO2 ~ 1&quot;) &amp; !str_detect(focal_formula, &quot;RQ ~ 1&quot;)){
    model &lt;- brm(focal_formula, 
                 data = my_data, 
                 iter = 10000, chains = 4, cores = 1,
                 prior = prior(normal(0, 3), class = &quot;b&quot;, resp = &quot;VCO2&quot;, nlpar = &quot;RQ&quot;),
                 control = list(max_treedepth = 20, adapt_delta = 0.99),
                 save_all_pars = TRUE)
  }
  if(str_detect(focal_formula, &quot;VO2 ~ 1&quot;) &amp; str_detect(focal_formula, &quot;RQ ~ 1&quot;)){
    model &lt;- brm(focal_formula, 
                 data = my_data, 
                 iter = 10000, chains = 4, cores = 1,
                 control = list(max_treedepth = 20, adapt_delta = 0.99),
                 save_all_pars = TRUE)
  }
  
  saveRDS(model, file = file_name)
  rm(model) # Force clean up to help R not run out of memory
  gc()
  return(NULL)
}

# Run all the models in parallel over 4 cores - this worked fine on a 2015 iMac with 32GB RAM
options(mc.cores=4)
plan(multiprocess)

future_lapply(1:length(all_formulas), 
              run_model, 
              formula_list = all_formulas, 
              my_data = scaled_data)</code></pre>
</div>
<div id="compare-all-the-fitted-brms-models-using-leave-one-out-cross-validation-loo" class="section level3">
<h3>Compare all the fitted <code>brms</code> models using leave-one-out cross validation (LOO)</h3>
<p>It is not possible to load all the models without running out of memory, so I here use a simple algorithm to select the top 10 models. The algorithm picks 20 candidate models at random, ranks them using LOO, and then removes the 10 worst-fitting models from the list of models under comparison. This is repeated until only 10 models remain - these are the 10 best-fitting models as ranked by LOO (under the PSIS-LOO approximation; see the <code>loo</code> package documentation and papers by Aki Vehtari and colleagues).</p>
<pre class="r"><code>if(!file.exists(&quot;data/model_selection_table.rds&quot;)){
  
  # Get the file names of the 361 models
  out_files &lt;- list.files(&quot;/Volumes/LACIE_SHARE/brms_respiration&quot;, full.names = TRUE)
  
  # Algorithm to pick the top 10 models without running out of memory
  while(length(out_files) &gt; 20){
    
    # Pick 20 random models that have not yet been eliminated
    sampled_files &lt;- sample(out_files, 20)
    
    # Rank all 20 models using LOO cross-validation
    weights &lt;- model_weights(
      readRDS(sampled_files[1]), readRDS(sampled_files[2]),
      readRDS(sampled_files[3]), readRDS(sampled_files[4]),
      readRDS(sampled_files[5]), readRDS(sampled_files[6]),
      readRDS(sampled_files[7]), readRDS(sampled_files[8]),
      readRDS(sampled_files[9]), readRDS(sampled_files[10]),
      readRDS(sampled_files[11]), readRDS(sampled_files[12]),
      readRDS(sampled_files[13]), readRDS(sampled_files[14]),
      readRDS(sampled_files[15]), readRDS(sampled_files[16]),
      readRDS(sampled_files[17]), readRDS(sampled_files[18]),
      readRDS(sampled_files[19]), readRDS(sampled_files[20]),
      weights = &quot;loo&quot;)
    
    # Discard all but the 10 top-ranked models from the set still to be compared
    to_keep &lt;- sampled_files[order(weights, decreasing=TRUE)[1:10]]
    to_remove &lt;- sampled_files[!(sampled_files %in% to_keep)]
    out_files &lt;- out_files[!(out_files %in% to_remove)]
    print(paste(length(out_files), &quot;left to compare&quot;))
  }
  
  top_model_files &lt;- out_files
  saveRDS(top_model_files, &quot;data/top_model_files.rds&quot;)
  
  # Get the weights for the top 10 models
  resp_model_weights &lt;- model_weights(
    readRDS(top_model_files[1]), readRDS(top_model_files[2]),
    readRDS(top_model_files[3]), readRDS(top_model_files[4]),
    readRDS(top_model_files[5]), readRDS(top_model_files[6]),
    readRDS(top_model_files[7]), readRDS(top_model_files[8]),
    readRDS(top_model_files[9]), readRDS(top_model_files[10]),
    weights = &quot;loo&quot;
  )
  
  # Format them nicely in a table
  resp_model_weights &lt;- round(resp_model_weights, 3) 
  names(resp_model_weights) &lt;- out_files[as.numeric(str_extract(names(resp_model_weights), &quot;[:digit:]+&quot;))]
  names(resp_model_weights) &lt;- all_formulas[as.numeric(str_extract(names(resp_model_weights), &quot;[:digit:]+&quot;))]
  
  model_selection_table &lt;- enframe(resp_model_weights, name = &quot;Model&quot;, value = &quot;LOO model weight&quot;) %&gt;%
    arrange(-`LOO model weight`) %&gt;%
    mutate(Model = str_remove_all(Model, &quot; \\+ \\(1 \\| LINE\\) \\+ \\(1 \\| SAMPLE\\)\\) \\+ bf\\(&quot;),
           Model = str_remove_all(Model, &quot;bf\\(&quot;),
           Model = str_remove_all(Model, &quot;~ VO2 \\* \\(0.7 \\+ 0.3 \\* inv_logit\\(RQ\\)\\), &quot;),
           Model = str_remove_all(Model, &quot; \\+ \\(1 \\| LINE\\) \\+ \\(1 \\| SAMPLE\\), nl = TRUE\\) \\+ set_rescor\\(FALSE\\)&quot;)) %&gt;%
    mutate(split = strsplit(Model, split = &quot; RQ&quot;),
           `Model of VO2` = map_chr(split, ~ .x[1]),
           `Model of RQ` = map_chr(split, ~ .x[2])) %&gt;%
    mutate(`Model of VO2` = str_remove_all(`Model of VO2`, &quot;VO2 &quot;),
           `Model of VO2` = str_remove_all(`Model of VO2`, &quot;VCO2&quot;),
           `Model of RQ` = str_replace_all(`Model of RQ`, &quot; ~&quot;, &quot;~&quot;)) %&gt;%
    select(`Model of VO2`, `Model of RQ`, `LOO model weight`) 
  
  saveRDS(model_selection_table, file = &quot;data/model_selection_table.rds&quot;)
} else {
  top_model_files &lt;- readRDS(&quot;data/top_model_files.rds&quot;)
  model_selection_table &lt;- readRDS(&quot;data/model_selection_table.rds&quot;)
}</code></pre>
<div id="model-selection-table" class="section level4">
<h4>Model selection table</h4>
<p>This table shows the top ten models from the set of 361 that was compared. The models were compared using leave-one-out cross validation (LOO), which is similar to more familiar metrics like AIC, but is regarded as the current best method for comparing the fit of a set of Bayesian models (see the documentation in <code>brms</code> and <code>loo</code> packages).</p>
<pre class="r"><code>model_selection_table %&gt;%
  kable() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Model of VO2
</th>
<th style="text-align:left;">
Model of RQ
</th>
<th style="text-align:right;">
LOO model weight
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
~ CYCLE + SEX + CYCLE:SEX
</td>
<td style="text-align:left;">
~ CYCLE
</td>
<td style="text-align:right;">
0.381
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SELECTION + SEX + CYCLE:SEX
</td>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:right;">
0.209
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SELECTION + SEX + SELECTION:SEX
</td>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:right;">
0.189
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:left;">
~ CYCLE
</td>
<td style="text-align:right;">
0.099
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:right;">
0.063
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:left;">
~ SEX
</td>
<td style="text-align:right;">
0.034
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SELECTION + SEX
</td>
<td style="text-align:left;">
~ CYCLE + SEX
</td>
<td style="text-align:right;">
0.008
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SELECTION + SEX + CYCLE:SELECTION
</td>
<td style="text-align:left;">
~ 1
</td>
<td style="text-align:right;">
0.008
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SELECTION + SEX + CYCLE:SELECTION
</td>
<td style="text-align:left;">
~ CYCLE
</td>
<td style="text-align:right;">
0.005
</td>
</tr>
<tr>
<td style="text-align:left;">
~ CYCLE + SEX + CYCLE:SEX
</td>
<td style="text-align:left;">
~ SEX
</td>
<td style="text-align:right;">
0.005
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="inspect-the-parameter-estimates" class="section level3">
<h3>Inspect the parameter estimates</h3>
<div id="perform-bayesian-model-averaging" class="section level4">
<h4>Perform Bayesian model averaging</h4>
<p>Since there is no model that was strongly preferred to all the others, we here perform model averaging to calculate the parameter estimates for all the fixed effects that were present in at least 1 of the top 3 models. Parameters that were not present in all models were set to zero for models that lacked that parameter: this is sometimes called “full model averaging” (see e.g. ?MuMIn::model.avg), and it applies “shrinkage”, meaning that parameters that are not present in all of the top models get shrunk somewhat towards zero. The models are averaged according to their “stacking weights”, which is the current state-of-the-art for Bayesian model averaging (see e.g. <a href="https://mc-stan.org/loo/articles/loo2-weights.html">here</a>).</p>
<pre class="r"><code>avg &lt;- posterior_average(
  readRDS(top_model_files[1]), readRDS(top_model_files[2]), readRDS(top_model_files[3]),
  weights = &quot;stacking&quot;, missing = 0) %&gt;%
  select(contains(&quot;b_&quot;), contains(&quot;sd_&quot;))

make_model_summary_table &lt;- function(posterior_samples){
  pvalues &lt;- summarise_all(posterior_samples, p_direction) %&gt;% 
    gather(key, p) %&gt;%
    mutate(p = 1 - p) %&gt;%
    mutate(` ` = ifelse(p &lt; 0.05, &quot;\\*&quot;, &quot;&quot;),
           ` ` = replace(` `, p &gt; 0.05 &amp; p &lt; 0.1, &quot;~&quot;),
           ` ` = replace(` `, p &lt; 0.01, &quot;**&quot;), 
           ` ` = replace(` `, p &lt; 0.001, &quot;***&quot;))
  
  posterior_samples %&gt;%
    summarise_all(~ list(posterior_summary(.x)))  %&gt;% gather() %&gt;% 
    mutate(Estimate = map_dbl(value, ~ .x[1]),
           Error = map_dbl(value, ~ .x[2]),
           Lower_95_CI = map_dbl(value, ~ .x[3]),
           Upper_95_CI = map_dbl(value, ~ .x[4])) %&gt;% 
    select(-value) %&gt;%
    left_join(pvalues, by = &quot;key&quot;) %&gt;%
    mutate_if(is.numeric, ~ round(.x, 3)) %&gt;%
    mutate(p = replace(p, grepl(&quot;sd_&quot;, key), &quot; &quot;),
           p = replace(p, grepl(&quot;sigma_&quot;, key), &quot; &quot;),
           p = replace(p, grepl(&quot;Intercept_&quot;, key), &quot; &quot;),
           ` ` = replace(` `, grepl(&quot;sd_&quot;, key), &quot; &quot;),
           ` ` = replace(` `, grepl(&quot;sigma_&quot;, key), &quot; &quot;),
           ` ` = replace(` `, grepl(&quot;Intercept_&quot;, key), &quot; &quot;))
}</code></pre>
</div>
</div>
<div id="inspect-tables-of-results" class="section level3 tabset">
<h3>Inspect tables of results</h3>
<p>Here we present the model-averaged estimates for each of the fixed effects, as well as the results for the top model that contained our most interesting predictor, namely the M vs P selection treatment (i.e. the second-best model in the model selection table).</p>
<div id="results-from-model-averaging" class="section level4">
<h4>Results from model averaging</h4>
<pre class="r"><code>model_averaging_results &lt;- avg %&gt;%
  select(-starts_with(&quot;r_&quot;), -starts_with(&quot;z_&quot;), -starts_with(&quot;lp&quot;)) %&gt;% 
  make_model_summary_table()

model_averaging_results %&gt;%
  kable() %&gt;%
  kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
key
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Error
</th>
<th style="text-align:right;">
Lower_95_CI
</th>
<th style="text-align:right;">
Upper_95_CI
</th>
<th style="text-align:left;">
p
</th>
<th style="text-align:left;">
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_VO2_Intercept
</td>
<td style="text-align:right;">
7.547
</td>
<td style="text-align:right;">
0.646
</td>
<td style="text-align:right;">
6.275
</td>
<td style="text-align:right;">
8.836
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_CYCLEII
</td>
<td style="text-align:right;">
-0.892
</td>
<td style="text-align:right;">
0.271
</td>
<td style="text-align:right;">
-1.419
</td>
<td style="text-align:right;">
-0.344
</td>
<td style="text-align:left;">
0.002
</td>
<td style="text-align:left;">
**
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_CYCLEIII
</td>
<td style="text-align:right;">
-1.893
</td>
<td style="text-align:right;">
0.298
</td>
<td style="text-align:right;">
-2.423
</td>
<td style="text-align:right;">
-1.238
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_SELECTIONPoly
</td>
<td style="text-align:right;">
1.167
</td>
<td style="text-align:right;">
0.851
</td>
<td style="text-align:right;">
-0.586
</td>
<td style="text-align:right;">
2.764
</td>
<td style="text-align:left;">
0.082
</td>
<td style="text-align:left;">
~
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_SEXM
</td>
<td style="text-align:right;">
-1.326
</td>
<td style="text-align:right;">
0.630
</td>
<td style="text-align:right;">
-2.538
</td>
<td style="text-align:right;">
-0.093
</td>
<td style="text-align:left;">
0.017
</td>
<td style="text-align:left;">
*
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_SELECTIONPoly:SEXM
</td>
<td style="text-align:right;">
0.760
</td>
<td style="text-align:right;">
0.814
</td>
<td style="text-align:right;">
-0.176
</td>
<td style="text-align:right;">
2.471
</td>
<td style="text-align:left;">
0.38
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_Intercept
</td>
<td style="text-align:right;">
0.298
</td>
<td style="text-align:right;">
0.300
</td>
<td style="text-align:right;">
-0.288
</td>
<td style="text-align:right;">
0.906
</td>
<td style="text-align:left;">
0.136
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_CYCLEII
</td>
<td style="text-align:right;">
0.066
</td>
<td style="text-align:right;">
0.227
</td>
<td style="text-align:right;">
-0.380
</td>
<td style="text-align:right;">
0.515
</td>
<td style="text-align:left;">
0.387
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_CYCLEIII
</td>
<td style="text-align:right;">
0.005
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
-0.479
</td>
<td style="text-align:right;">
0.490
</td>
<td style="text-align:left;">
0.494
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_SEXM
</td>
<td style="text-align:right;">
0.161
</td>
<td style="text-align:right;">
0.279
</td>
<td style="text-align:right;">
-0.389
</td>
<td style="text-align:right;">
0.703
</td>
<td style="text-align:left;">
0.275
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_CYCLEII:SEXM
</td>
<td style="text-align:right;">
-0.021
</td>
<td style="text-align:right;">
0.269
</td>
<td style="text-align:right;">
-0.737
</td>
<td style="text-align:right;">
0.595
</td>
<td style="text-align:left;">
0.812
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_CYCLEIII:SEXM
</td>
<td style="text-align:right;">
-0.178
</td>
<td style="text-align:right;">
0.367
</td>
<td style="text-align:right;">
-1.192
</td>
<td style="text-align:right;">
0.149
</td>
<td style="text-align:left;">
0.704
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_LINE__VO2_Intercept
</td>
<td style="text-align:right;">
0.850
</td>
<td style="text-align:right;">
0.492
</td>
<td style="text-align:right;">
0.112
</td>
<td style="text-align:right;">
2.064
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_SAMPLE__VO2_Intercept
</td>
<td style="text-align:right;">
1.202
</td>
<td style="text-align:right;">
0.191
</td>
<td style="text-align:right;">
0.859
</td>
<td style="text-align:right;">
1.608
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_LINE__VCO2_RQ_Intercept
</td>
<td style="text-align:right;">
0.475
</td>
<td style="text-align:right;">
0.336
</td>
<td style="text-align:right;">
0.031
</td>
<td style="text-align:right;">
1.275
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_SAMPLE__VCO2_RQ_Intercept
</td>
<td style="text-align:right;">
0.613
</td>
<td style="text-align:right;">
0.209
</td>
<td style="text-align:right;">
0.202
</td>
<td style="text-align:right;">
1.040
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
</tbody>
</table>
</div>
<div id="results-from-the-individual-top-model-containing-selection" class="section level4">
<h4>Results from the individual top model containing selection</h4>
<pre class="r"><code>top_model_with_selection &lt;- posterior_samples(readRDS(top_model_files[2])) %&gt;%
  select(-starts_with(&quot;r_&quot;), -starts_with(&quot;z_&quot;), -starts_with(&quot;lp&quot;), -starts_with(&quot;Intercept_&quot;)) %&gt;% 
  make_model_summary_table()

top_model_with_selection %&gt;%
  kable() %&gt;%
  kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
key
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Error
</th>
<th style="text-align:right;">
Lower_95_CI
</th>
<th style="text-align:right;">
Upper_95_CI
</th>
<th style="text-align:left;">
p
</th>
<th style="text-align:left;">
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_VO2_Intercept
</td>
<td style="text-align:right;">
7.405
</td>
<td style="text-align:right;">
0.619
</td>
<td style="text-align:right;">
6.211
</td>
<td style="text-align:right;">
8.679
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_CYCLEII
</td>
<td style="text-align:right;">
-0.901
</td>
<td style="text-align:right;">
0.233
</td>
<td style="text-align:right;">
-1.354
</td>
<td style="text-align:right;">
-0.437
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_CYCLEIII
</td>
<td style="text-align:right;">
-1.983
</td>
<td style="text-align:right;">
0.234
</td>
<td style="text-align:right;">
-2.445
</td>
<td style="text-align:right;">
-1.522
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_SELECTIONPoly
</td>
<td style="text-align:right;">
1.521
</td>
<td style="text-align:right;">
0.768
</td>
<td style="text-align:right;">
-0.095
</td>
<td style="text-align:right;">
3.006
</td>
<td style="text-align:left;">
0.029
</td>
<td style="text-align:left;">
*
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VO2_SEXM
</td>
<td style="text-align:right;">
-1.017
</td>
<td style="text-align:right;">
0.406
</td>
<td style="text-align:right;">
-1.830
</td>
<td style="text-align:right;">
-0.216
</td>
<td style="text-align:left;">
0.008
</td>
<td style="text-align:left;">
**
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_Intercept
</td>
<td style="text-align:right;">
0.305
</td>
<td style="text-align:right;">
0.305
</td>
<td style="text-align:right;">
-0.278
</td>
<td style="text-align:right;">
0.929
</td>
<td style="text-align:left;">
0.138
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_CYCLEII
</td>
<td style="text-align:right;">
0.064
</td>
<td style="text-align:right;">
0.233
</td>
<td style="text-align:right;">
-0.390
</td>
<td style="text-align:right;">
0.518
</td>
<td style="text-align:left;">
0.394
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_CYCLEIII
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
-0.486
</td>
<td style="text-align:right;">
0.488
</td>
<td style="text-align:left;">
0.499
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
b_VCO2_RQ_SEXM
</td>
<td style="text-align:right;">
0.157
</td>
<td style="text-align:right;">
0.281
</td>
<td style="text-align:right;">
-0.399
</td>
<td style="text-align:right;">
0.705
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_LINE__VO2_Intercept
</td>
<td style="text-align:right;">
0.832
</td>
<td style="text-align:right;">
0.508
</td>
<td style="text-align:right;">
0.092
</td>
<td style="text-align:right;">
2.054
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_SAMPLE__VO2_Intercept
</td>
<td style="text-align:right;">
1.227
</td>
<td style="text-align:right;">
0.189
</td>
<td style="text-align:right;">
0.888
</td>
<td style="text-align:right;">
1.630
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_LINE__VCO2_RQ_Intercept
</td>
<td style="text-align:right;">
0.480
</td>
<td style="text-align:right;">
0.341
</td>
<td style="text-align:right;">
0.029
</td>
<td style="text-align:right;">
1.313
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_SAMPLE__VCO2_RQ_Intercept
</td>
<td style="text-align:right;">
0.618
</td>
<td style="text-align:right;">
0.212
</td>
<td style="text-align:right;">
0.201
</td>
<td style="text-align:right;">
1.054
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_VO2
</td>
<td style="text-align:right;">
1.150
</td>
<td style="text-align:right;">
0.086
</td>
<td style="text-align:right;">
0.997
</td>
<td style="text-align:right;">
1.333
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_VCO2
</td>
<td style="text-align:right;">
0.537
</td>
<td style="text-align:right;">
0.040
</td>
<td style="text-align:right;">
0.466
</td>
<td style="text-align:right;">
0.624
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="plot-the-parameter-estimates" class="section level3 tabset">
<h3>Plot the parameter estimates</h3>
<p>Again, we plot the estimates for model averaging, or the top model that contained selection treatment. We do not plot the estimates for RQ, since none of the parameter estimates clearly differed from zero.</p>
<div id="model-averaged-estimates" class="section level4">
<h4>Model averaged estimates</h4>
<pre class="r"><code>name_converter &lt;- tibble(
  new_name = c(&quot;O2: Effect of being male&quot;, &quot;O2: Effect of P treatment&quot;, &quot;O2: Effect of Cycle II&quot;, &quot;O2: Effect of Cycle III&quot;,
               &quot;O2: Male x Cycle II interaction&quot;, &quot;O2: Male x Cycle III interaction&quot;,
               &quot;RQ: Effect of being male&quot;, &quot;RQ: Effect of Cycle II&quot;, &quot;RQ: Effect of Cycle III&quot;),
  old_name = c(&quot;VO2_SEXM&quot;, &quot;VO2_SELECTIONPoly&quot;, &quot;VO2_CYCLEII&quot;, &quot;VO2_CYCLEIII&quot;,
               &quot;VO2_CYCLEII:SEXM&quot;, &quot;VO2_CYCLEIII:SEXM&quot;,
               &quot;VCO2_RQ_SEXM&quot;, &quot;VCO2_RQ_CYCLEII&quot;, &quot;VCO2_RQ_CYCLEIII&quot;)
) %&gt;% mutate(new_name = factor(new_name, rev(new_name)))

plotter &lt;- function(posterior_samples){
  
  posterior_samples %&gt;% 
    as_tibble() %&gt;%
    select(contains(&quot;b_&quot;), -contains(&quot;Intercept&quot;)) %&gt;%
    gather() %&gt;% 
    mutate(key = str_remove_all(key, &quot;b_&quot;)) %&gt;%
    left_join(name_converter, by = c(&quot;key&quot; = &quot;old_name&quot;)) %&gt;%
    filter(value &lt; 4.2) %&gt;%
    mutate(variable = ifelse(grepl(&quot;O2&quot;, new_name), &quot;O2&quot;, &quot;RQ&quot;)) %&gt;%
    filter(variable == &quot;O2&quot;) %&gt;%
    mutate(new_name = factor(str_remove(as.character(new_name), &quot;O2: &quot;),
                             rev(unique(str_remove(as.character(new_name), &quot;O2: &quot;))))) %&gt;%
    filter(value &gt; -3.2) %&gt;%
    ggplot(aes(value, new_name, fill = stat(x))) + 
    geom_vline(xintercept = 0, linetype = 2) + 
    geom_density_ridges_gradient() +
    scale_fill_viridis_c(option = &quot;C&quot;) +
    ylab(&quot;Parameter&quot;) +
    xlab(bquote(&#39;Posterior effect size estimate (&#39;*mm^3~O[2]*&#39;)&#39;)) + 
    theme_ridges() +
    theme(legend.position = &quot;none&quot;)
  
}

plotter(avg)</code></pre>
<p><img src="figure/statistics.Rmd/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-13-1">
Past versions of unnamed-chunk-13-1.png
</button>
</p>
<div id="fig-unnamed-chunk-13-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/lukeholman/exp_evol_respiration/blob/27523526d153b1705871bfc150cb04416f53af88/docs/figure/statistics.Rmd/unnamed-chunk-13-1.png" target="_blank">2752352</a>
</td>
<td>
lukeholman
</td>
<td>
2020-01-17
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="estimates-from-the-individual-top-model-containing-selection" class="section level4">
<h4>Estimates from the individual top model containing selection</h4>
<pre class="r"><code>plotter(readRDS(top_model_files[2]))</code></pre>
<p><img src="figure/statistics.Rmd/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-14-1">
Past versions of unnamed-chunk-14-1.png
</button>
</p>
<div id="fig-unnamed-chunk-14-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/lukeholman/exp_evol_respiration/blob/27523526d153b1705871bfc150cb04416f53af88/docs/figure/statistics.Rmd/unnamed-chunk-14-1.png" target="_blank">2752352</a>
</td>
<td>
lukeholman
</td>
<td>
2020-01-17
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="plot-posterior-predictive-checks" class="section level3">
<h3>Plot posterior predictive checks</h3>
<p>Finally, we check that the values predicted by the (second-top) model resemble the real data (which they should, if the model is an adequate approximation of the true ‘data-generating processes’). This is done by drawing 10 samples from the posterior of the model, and using them to produce some new data (here, for VO2). The plot looks good, because the predicted data look similar to the original data, which is a necessary condiction for reliable inference.</p>
<pre class="r"><code>pp_check(readRDS(top_model_files[2]), resp = &quot;VO2&quot;)</code></pre>
<p><img src="figure/statistics.Rmd/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-15-1">
Past versions of unnamed-chunk-15-1.png
</button>
</p>
<div id="fig-unnamed-chunk-15-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/lukeholman/exp_evol_respiration/blob/27523526d153b1705871bfc150cb04416f53af88/docs/figure/statistics.Rmd/unnamed-chunk-15-1.png" target="_blank">2752352</a>
</td>
<td>
lukeholman
</td>
<td>
2020-01-17
</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Old code chunk for simple brms: -->
<!-- ```{r eval = FALSE} -->
<!-- brms_formula <-  -->
<!--   bf(VO2 ~ SELECTION * SEX * CYCLE +  -->
<!--        (1 | LINE) + (1 | SAMPLE)) + -->
<!--   bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)),  -->
<!--      RQ ~ SELECTION * SEX * CYCLE +  -->
<!--        (1 | LINE) + (1 | SAMPLE), -->
<!--      nl = TRUE) + -->
<!--   set_rescor(FALSE) -->
<!-- brms_simple <- brm( -->
<!--   brms_formula,   -->
<!--   data = scaled_data, -->
<!--   iter = 10000, chains = 4, cores = 1, -->
<!--   prior = c(prior(normal(0, 3), class = "b", resp = "VO2"), -->
<!--             prior(normal(0, 3), class = "b", resp = "VCO2", nlpar = "RQ")), -->
<!--   control = list(max_treedepth = 20, adapt_delta = 0.99) -->
<!-- ) -->
<!-- pvalues <- as.data.frame(p_direction(brms_simple)) %>%  -->
<!--   mutate(Parameter = str_remove_all(Parameter, "b_"), -->
<!--          Parameter = str_replace_all(Parameter, "[.]", ":"), -->
<!--          p = 1- pd)  %>% select(Parameter, p) %>% distinct() -->
<!-- fixef(brms_simple) %>%  -->
<!--   as.data.frame() %>% -->
<!--   rownames_to_column("Parameter") %>% -->
<!--   left_join(pvalues, by = "Parameter") %>% -->
<!--   mutate(` ` = ifelse(p < 0.05, "\\*", ""), -->
<!--          ` ` = replace(` `, p > 0.05 & p < 0.1, "~"), -->
<!--          ` ` = replace(` `, p < 0.01, "**"),  -->
<!--          ` ` = replace(` `, p < 0.001, "***")) %>% -->
<!--   mutate(Response = map_chr(strsplit(Parameter, split = "_"), ~ .x[1]), -->
<!--          Response = str_replace_all(Response, "BODYMASS", "Body mass"), -->
<!--          Response = str_replace_all(Response, "ACTIVITY", "Activity"), -->
<!--          Response = str_replace_all(Response, "VCO2", "RQ"), -->
<!--          Parameter = str_replace_all(Parameter, "BODYMASS", "Body mass"), -->
<!--          Parameter = str_replace_all(Parameter, "ACTIVITY", "Activity"), -->
<!--          Parameter = str_remove_all(Parameter, ".+_"), -->
<!--          Parameter = str_replace_all(Parameter, "SELECTIONPoly", "Polyandry"), -->
<!--          Parameter = str_replace_all(Parameter, "CYCLEIII", "Cycle III"), -->
<!--          Parameter = str_replace_all(Parameter, "CYCLEII", "Cycle II"), -->
<!--          Parameter = str_replace_all(Parameter, "SEXM", "Male"), -->
<!--          Parameter = str_replace_all(Parameter, ":", " x ")) %>% -->
<!--   select(Response, Parameter, everything()) %>% -->
<!--   mutate(Response = factor(Response,  -->
<!--                            c("VO2", "RQ"))) %>% -->
<!--   arrange(Response) %>% select(-Response) %>% -->
<!--   kable(digits = 3) %>% kable_styling() %>% -->
<!--   group_rows("VO2", 1, 12) %>% -->
<!--   group_rows("Respiratory quotient (RQ)", 13, 24) -->
<!-- mean_VO2 <- mean(scaled_data$VO2) -->
<!-- new <- scaled_data %>% select(SELECTION, SEX, CYCLE) %>%  -->
<!--   distinct() %>%  -->
<!--   mutate(VO2 = mean_VO2) %>%  -->
<!--   mutate(key = paste("V", 1:n(), sep = "")) -->
<!-- preds_VO2 <- fitted(brms_simple, newdata = new, re_formula = NA, resp = "VO2", summary = FALSE) %>%  -->
<!--   as.data.frame() %>% -->
<!--   gather() %>% left_join(new, by = "key") %>% select(-key) %>% mutate(resp = "VO2") %>% -->
<!--   mutate(SEX = ifelse(SEX =="M", "Male", "Female")) -->
<!-- preds_RQ <- fitted(brms_simple, newdata = new, re_formula = NA, resp = "VCO2", nlpar = "RQ", summary = FALSE) %>%  -->
<!--   as.data.frame() %>% -->
<!--   gather() %>% left_join(new, by = "key") %>% select(-key) %>% -->
<!--                  mutate(value = 0.7 + 0.3 * inv_logit(value), -->
<!--                         resp = "RQ") %>% -->
<!--   mutate(SEX = ifelse(SEX =="M", "Male", "Female")) -->
<!-- grid.arrange( -->
<!--   preds_VO2 %>% -->
<!--     ggplot(aes(CYCLE, value, fill = SELECTION)) +  -->
<!--     geom_eye(position = position_dodge(0.8), alpha = 0.6) + -->
<!--     scale_fill_brewer(palette = "Set1", direction = -1, name = "") + -->
<!--     facet_wrap( ~ SEX, scales = "free_y") +  -->
<!--     coord_cartesian(ylim = c(1, 11)) + ylab("O2 consumed"), -->
<!--   preds_RQ %>% -->
<!--     ggplot(aes(CYCLE, value, fill = SELECTION)) +  -->
<!--     geom_eye(position = position_dodge(0.8), alpha = 0.6) + -->
<!--     scale_fill_brewer(palette = "Set1", direction = -1, name = "") + -->
<!--     facet_wrap( ~ SEX, scales = "free_y") + ylab("RQ") -->
<!-- ) -->
<!-- ``` -->
</div>
</div>
<div id="fit-the-brms-structural-equation-model-sem" class="section level2">
<h2>Fit the <code>brms</code> structural equation model (SEM)</h2>
<p>This next section fits a more complex version of previous multivariate model, which additionally includes the “mediator variables” (for definition, see e.g. <a href="https://en.wikipedia.org/wiki/Mediation_(statistics)">Wikipedia</a>) body mass and activity. The mediator variables potentially vary between sexes and selection treatments (and cycle, in the case of activity, but not body size), but they also potentially affect the main response variables VO2 and RQ. Therefore, body mass and activity potentially “mediate” the effect of treatment, sex, and cycle on respiration. Using a structural equation model, one can partition an effect (e.g. the effect of treatment on respiration) into the share that is due to mediation vs other processes. For a good introduction to causal inference using Bayesian statistics, see <a href="https://www.youtube.com/watch?v=0Jc6Kgw5qc0&amp;list=PLDcUM9US4XdNM4Edgs7weiyIguLSToZRI&amp;index=7">this video lecture</a> and others in that series.</p>
<p>Because this extra-complex model takes a while to compute, it is prohibitive to run many models and select among them. We therefore forego a model selection step here, and simply fit the full model and analyse it.</p>
<div id="formulae-in-the-structural-equation-model" class="section level3">
<h3>Formulae in the structural equation model</h3>
<p>The SEM contains two additional formulae than the previous model, as well as additional predictor variables.</p>
<p>There is a sub-model for both of the mediator variables (activity and body mass), a model of oxygen production (VO2), and a model of CO2 production (VCO2, which is related to VO2 via the parameter RQ, the respiratory quotient, which the model also estimates).</p>
<p>The formulae were chosen <em>a priori</em>, to reflect our biological intuition about the direction of causality, and the factors that might affect each response variable.</p>
<div id="activity-level-one-value-per-cycle-i.e.3-measures-on-each-sample-of-individuals" class="section level4">
<h4>Activity level (one value per cycle, i.e. 3 measures on each ‘sample’ of individuals)</h4>
<p>Formula: <code>ACTIVITY ~ SELECTION * SEX + CYCLE + (1 | LINE) + (1 | SAMPLE)</code></p>
<p>This formula allows for effects on activity of sex and selection treatment (and their 2-way interaction), and for an effect of cycle (coded as a 3-level factor, allowing non-linear change across the 3 cycles). The random factors were added due to our repeated measures of replicate selection lines and samples (same for the following forrmulae).</p>
</div>
<div id="body-mass" class="section level4">
<h4>Body mass</h4>
<p>Formula: <code>BODYMASS ~ SELECTION * SEX + (1 | LINE)</code></p>
<p>This formula allows for effects on activity of sex and selection treatment (and their 2-way interaction). Because there is only one measure of body mass for each sample of flies, we do not need to fit a sample-level random effect; also, this model is run on only a subset of the full dataset (one of the 3 cycles), since we would incur pseudo-replication if we used the full dataset. Note that this means there is less replication for body mass than for the other variables, and so the parameter estimates are less precise for this model (visible in the figures plotted later).</p>
</div>
<div id="vo2-1" class="section level4">
<h4>VO2</h4>
<p>Formula: <code>VO2 ~ SELECTION * SEX * CYCLE + BODYMASS + ACTIVITY +</code><br />
<code>SELECTION:BODYMASS + SELECTION:ACTIVITY +</code> <code>SEX:BODYMASS + SEX:ACTIVITY + (1 | LINE) + (1 | SAMPLE)</code></p>
<p>This formula allows for effects on activity of sex, selection and cycle (and their 2- and 3-way interactions), and for sex- and selection treatment-specific effects of body mass and activity level.</p>
</div>
<div id="vco2-as-determined-by-the-parameter-rq-1" class="section level4">
<h4>VCO2 (as determined by the parameter RQ)</h4>
<p>Formulae (2-part model, see <code>vignette(&quot;brms_nonlinear&quot;)</code>):</p>
<p><code>VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ))</code></p>
<p><code>RQ ~ SELECTION * SEX * CYCLE + BODYMASS + ACTIVITY +</code><br />
<code>SELECTION:BODYMASS + SELECTION:ACTIVITY +</code> <code>SEX:BODYMASS + SEX:ACTIVITY + (1 | LINE) + (1 | SAMPLE)</code></p>
<p>VCO2 is assumed to depend on the value of VO2 from the same measurement, multiplied by RQ, a parameter that is constrained to vary between 0.7 and 1 (based on our prior knowledge of the chemistry of respiration) through the use of the inverse logit function. In turn, RQ is assumed to depend on the same set of predictors as for VO2.</p>
</div>
<div id="priors-1" class="section level4">
<h4>Priors</h4>
<p>To apply some mild regularisation and assist model convergence, we set a prior on all the fixed effect parameters of <code>normal(0, 3)</code>.</p>
</div>
<div id="family-1" class="section level4">
<h4>Family</h4>
<p>All response variables are assumed to follow a normal (Gaussian) distribution, except for activity level (which follows a beta distribution); as we shall see, this turns out to be a reasonable approximation of the response variables’ true distributions.</p>
</div>
</div>
<div id="fit-the-brms-model" class="section level3">
<h3>Fit the <code>brms</code> model</h3>
<pre class="r"><code># add a subsetting variable, so that we can estimate the effects of selection and sex 
# on body size without having three redundant measures of body size (one per cycle). 
# See ?brmsformula, section beginning &quot;For multivariate models, subset may be used...&quot;
scaled_data &lt;- scaled_data %&gt;%
      mutate(body_subset = CYCLE == &quot;I&quot;)

if(!file.exists(&quot;output/brms_SEM.rds&quot;)){
  
  # Set up formula for the SEM:
  brms_formula &lt;- 
    
    bf(VO2 ~ SELECTION * SEX * CYCLE +  # VO2 sub-model
         BODYMASS + ACTIVITY +  
         SELECTION:BODYMASS + SELECTION:ACTIVITY + 
         SEX:BODYMASS + SEX:ACTIVITY + 
         (1 | LINE) + (1 | SAMPLE)) +
    
    bf(VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)),   # VCO2 and RQ sub-models
       RQ ~ SELECTION * SEX * CYCLE + 
         BODYMASS + ACTIVITY + 
         SELECTION:BODYMASS + SELECTION:ACTIVITY + 
         SEX:BODYMASS + SEX:ACTIVITY + 
         (1 | LINE) + (1 | SAMPLE),
       nl = TRUE) +
    
    bf(BODYMASS | subset(body_subset) ~ SELECTION * SEX + # body mass sub-model
         (1 | LINE)) +
    
    bf(ACTIVITY ~ SELECTION * SEX + CYCLE +   # activity sub-model
         (1 | LINE) + (1 | SAMPLE), family = &quot;beta&quot;) +
    
    set_rescor(FALSE)
  
  # Run the SEM:
  brms_SEM &lt;- brm(
    brms_formula,  
    data = scaled_data,
    iter = 10000, chains = 4, cores = 1,
    prior = prior(normal(0, 3), class = &quot;b&quot;),
    control = list(max_treedepth = 20, adapt_delta = 0.99)
  )
  
  saveRDS(brms_SEM, file = &quot;output/brms_SEM.rds&quot;)
  
} else {
  brms_SEM &lt;- readRDS(&quot;output/brms_SEM.rds&quot;)
}</code></pre>
</div>
<div id="inspect-the-model-output" class="section level3">
<h3>Inspect the model output</h3>
<p>Here is the complete output of <code>summary()</code> called on the SEM. Note that the model has converged (Rhat = 1), and that no parameters are under-sampled (shown by the ESS columns). Several parameters also differ significantly from zero (shown by their 95% credible intervals not overlapping zero). Note that the response variables are not all in the same units, so the magnitudes of the parameter estimates (“Estimate” column) are not directly comparable between the response variables.</p>
<pre class="r"><code>summary(brms_SEM)</code></pre>
<pre><code> Family: MV(gaussian, gaussian, gaussian, beta) 
  Links: mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = logit; phi = identity 
Formula: VO2 ~ SELECTION * SEX * CYCLE + BODYMASS + ACTIVITY + SELECTION:BODYMASS + SELECTION:ACTIVITY + SEX:BODYMASS + SEX:ACTIVITY + (1 | LINE) + (1 | SAMPLE) 
         VCO2 ~ VO2 * (0.7 + 0.3 * inv_logit(RQ)) 
         RQ ~ SELECTION * SEX * CYCLE + BODYMASS + ACTIVITY + SELECTION:BODYMASS + SELECTION:ACTIVITY + SEX:BODYMASS + SEX:ACTIVITY + (1 | LINE) + (1 | SAMPLE)
         BODYMASS | subset(body_subset) ~ SELECTION * SEX + (1 | LINE) 
         ACTIVITY ~ SELECTION * SEX + CYCLE + (1 | LINE) + (1 | SAMPLE) 
   Data: scaled_data (Number of observations: 144) 
Samples: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;
         total post-warmup samples = 20000

Group-Level Effects: 
~LINE (Number of levels: 8) 
                       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
sd(VO2_Intercept)          0.90      0.55     0.09     2.23 1.00     4466
sd(VCO2_RQ_Intercept)      0.77      0.51     0.08     2.04 1.00     6701
sd(BODYMASS_Intercept)     0.61      0.30     0.21     1.38 1.00     4871
sd(ACTIVITY_Intercept)     0.16      0.13     0.01     0.49 1.00     4563
                       Tail_ESS
sd(VO2_Intercept)          5551
sd(VCO2_RQ_Intercept)      7995
sd(BODYMASS_Intercept)     7433
sd(ACTIVITY_Intercept)     9274

~SAMPLE (Number of levels: 48) 
                       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
sd(VO2_Intercept)          1.14      0.19     0.80     1.55 1.00     6664
sd(VCO2_RQ_Intercept)      0.70      0.24     0.24     1.20 1.00     5664
sd(ACTIVITY_Intercept)     0.48      0.08     0.35     0.64 1.00     7218
                       Tail_ESS
sd(VO2_Intercept)         11337
sd(VCO2_RQ_Intercept)      7303
sd(ACTIVITY_Intercept)    12750

Population-Level Effects: 
                                    Estimate Est.Error l-95% CI u-95% CI Rhat
VO2_Intercept                           7.58      0.71     6.21     8.99 1.00
BODYMASS_Intercept                      0.34      0.38    -0.40     1.09 1.00
ACTIVITY_Intercept                     -4.24      0.21    -4.65    -3.84 1.00
VO2_SELECTIONPoly                       0.30      0.98    -1.66     2.19 1.00
VO2_SEXM                               -1.13      0.82    -2.75     0.49 1.00
VO2_CYCLEII                            -1.29      0.43    -2.13    -0.46 1.00
VO2_CYCLEIII                           -1.79      0.43    -2.64    -0.95 1.00
VO2_BODYMASS                            0.12      0.67    -1.18     1.44 1.00
VO2_ACTIVITY                            5.32      2.87    -0.24    10.90 1.00
VO2_SELECTIONPoly:SEXM                  1.02      1.14    -1.20     3.24 1.00
VO2_SELECTIONPoly:CYCLEII               0.76      0.59    -0.40     1.92 1.00
VO2_SELECTIONPoly:CYCLEIII              0.05      0.60    -1.13     1.23 1.00
VO2_SEXM:CYCLEII                        0.14      0.60    -1.04     1.31 1.00
VO2_SEXM:CYCLEIII                      -0.87      0.60    -2.06     0.29 1.00
VO2_SELECTIONPoly:BODYMASS              0.07      0.72    -1.35     1.47 1.00
VO2_SELECTIONPoly:ACTIVITY              3.67      2.91    -2.05     9.38 1.00
VO2_SEXM:BODYMASS                       0.26      0.58    -0.88     1.39 1.00
VO2_SEXM:ACTIVITY                       2.49      2.96    -3.33     8.27 1.00
VO2_SELECTIONPoly:SEXM:CYCLEII         -0.32      0.83    -1.94     1.32 1.00
VO2_SELECTIONPoly:SEXM:CYCLEIII         0.84      0.83    -0.80     2.45 1.00
VCO2_RQ_Intercept                       0.07      0.58    -1.08     1.25 1.00
VCO2_RQ_SELECTIONPoly                   0.02      0.82    -1.61     1.67 1.00
VCO2_RQ_SEXM                            0.40      0.76    -1.05     1.94 1.00
VCO2_RQ_CYCLEII                         0.54      0.51    -0.42     1.57 1.00
VCO2_RQ_CYCLEIII                       -0.36      0.49    -1.36     0.57 1.00
VCO2_RQ_BODYMASS                        0.34      0.56    -0.77     1.47 1.00
VCO2_RQ_ACTIVITY                       -1.16      2.83    -6.65     4.36 1.00
VCO2_RQ_SELECTIONPoly:SEXM              0.19      0.95    -1.71     2.01 1.00
VCO2_RQ_SELECTIONPoly:CYCLEII          -0.00      0.62    -1.24     1.21 1.00
VCO2_RQ_SELECTIONPoly:CYCLEIII          1.01      0.65    -0.23     2.31 1.00
VCO2_RQ_SEXM:CYCLEII                   -0.63      0.77    -2.15     0.88 1.00
VCO2_RQ_SEXM:CYCLEIII                   0.67      0.91    -1.05     2.57 1.00
VCO2_RQ_SELECTIONPoly:BODYMASS         -0.15      0.58    -1.29     1.01 1.00
VCO2_RQ_SELECTIONPoly:ACTIVITY         -1.49      2.85    -7.08     4.08 1.00
VCO2_RQ_SEXM:BODYMASS                  -0.68      0.46    -1.61     0.23 1.00
VCO2_RQ_SEXM:ACTIVITY                   0.42      2.96    -5.29     6.31 1.00
VCO2_RQ_SELECTIONPoly:SEXM:CYCLEII     -0.62      0.94    -2.47     1.21 1.00
VCO2_RQ_SELECTIONPoly:SEXM:CYCLEIII    -1.86      1.07    -4.03     0.18 1.00
BODYMASS_SELECTIONPoly                  0.58      0.54    -0.50     1.65 1.00
BODYMASS_SEXM                          -1.05      0.27    -1.57    -0.51 1.00
BODYMASS_SELECTIONPoly:SEXM            -0.46      0.38    -1.21     0.29 1.00
ACTIVITY_SELECTIONPoly                  0.98      0.27     0.45     1.52 1.00
ACTIVITY_SEXM                           0.19      0.24    -0.29     0.65 1.00
ACTIVITY_CYCLEII                        0.10      0.09    -0.08     0.28 1.00
ACTIVITY_CYCLEIII                       0.03      0.09    -0.15     0.21 1.00
ACTIVITY_SELECTIONPoly:SEXM             0.11      0.32    -0.51     0.75 1.00
                                    Bulk_ESS Tail_ESS
VO2_Intercept                          13377    13435
BODYMASS_Intercept                     15324    12785
ACTIVITY_Intercept                     16101    14384
VO2_SELECTIONPoly                      13590    13924
VO2_SEXM                               12521    14156
VO2_CYCLEII                            17061    16623
VO2_CYCLEIII                           17491    15535
VO2_BODYMASS                           10385    14446
VO2_ACTIVITY                           45569    13932
VO2_SELECTIONPoly:SEXM                 10433    14075
VO2_SELECTIONPoly:CYCLEII              17927    16124
VO2_SELECTIONPoly:CYCLEIII             17986    16271
VO2_SEXM:CYCLEII                       17440    16103
VO2_SEXM:CYCLEIII                      17299    14267
VO2_SELECTIONPoly:BODYMASS              7988    13391
VO2_SELECTIONPoly:ACTIVITY             44939    13722
VO2_SEXM:BODYMASS                      16894    15547
VO2_SEXM:ACTIVITY                      44474    14896
VO2_SELECTIONPoly:SEXM:CYCLEII         18242    16391
VO2_SELECTIONPoly:SEXM:CYCLEIII        17884    16508
VCO2_RQ_Intercept                      13834    12824
VCO2_RQ_SELECTIONPoly                  14243    13052
VCO2_RQ_SEXM                           14429    14529
VCO2_RQ_CYCLEII                        18937    15284
VCO2_RQ_CYCLEIII                       21696    16521
VCO2_RQ_BODYMASS                       14917    14348
VCO2_RQ_ACTIVITY                       38027    14765
VCO2_RQ_SELECTIONPoly:SEXM             13085    14382
VCO2_RQ_SELECTIONPoly:CYCLEII          19232    15344
VCO2_RQ_SELECTIONPoly:CYCLEIII         21539    16077
VCO2_RQ_SEXM:CYCLEII                   18440    16064
VCO2_RQ_SEXM:CYCLEIII                  19896    13667
VCO2_RQ_SELECTIONPoly:BODYMASS         14203    13794
VCO2_RQ_SELECTIONPoly:ACTIVITY         38483    14961
VCO2_RQ_SEXM:BODYMASS                  21813    16141
VCO2_RQ_SEXM:ACTIVITY                  52827    14484
VCO2_RQ_SELECTIONPoly:SEXM:CYCLEII     18974    16162
VCO2_RQ_SELECTIONPoly:SEXM:CYCLEIII    19162    14252
BODYMASS_SELECTIONPoly                 15655    12051
BODYMASS_SEXM                          28186    15322
BODYMASS_SELECTIONPoly:SEXM            28218    15742
ACTIVITY_SELECTIONPoly                 13180    13382
ACTIVITY_SEXM                          14091    14960
ACTIVITY_CYCLEII                       34231    16178
ACTIVITY_CYCLEIII                      34350    16691
ACTIVITY_SELECTIONPoly:SEXM            11630    12999

Family Specific Parameters: 
               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma_VO2          1.11      0.09     0.95     1.29 1.00    14308    14743
sigma_VCO2         0.53      0.04     0.46     0.61 1.00    11252    13418
sigma_BODYMASS     0.66      0.08     0.53     0.85 1.00    18936    13303
phi_ACTIVITY     152.92     22.80   112.00   201.03 1.00    14884    15792

Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div id="make-a-neat-table-of-the-fixed-effects" class="section level3">
<h3>Make a neat table of the fixed effects</h3>
<pre class="r"><code>pvalues &lt;- as.data.frame(p_direction(brms_SEM)) %&gt;% 
  filter(!grepl(&quot;[.]1&quot;, Parameter)) %&gt;%
  mutate(Parameter = str_remove_all(Parameter, &quot;b_&quot;),
         Parameter = str_replace_all(Parameter, &quot;[.]&quot;, &quot;:&quot;),
         p = 1 - pd) %&gt;%
  select(Parameter, p) %&gt;% distinct()


fixef(brms_SEM) %&gt;% 
  as.data.frame() %&gt;%
  rownames_to_column(&quot;Parameter&quot;) %&gt;%
  left_join(pvalues, by = &quot;Parameter&quot;) %&gt;%
  mutate(` ` = ifelse(p &lt; 0.05, &quot;\\*&quot;, &quot;&quot;),
         ` ` = replace(` `, p &gt; 0.05 &amp; p &lt; 0.1, &quot;~&quot;),
         ` ` = replace(` `, p &lt; 0.01, &quot;**&quot;), 
         ` ` = replace(` `, p &lt; 0.001, &quot;***&quot;)) %&gt;%
  mutate(Response = map_chr(strsplit(Parameter, split = &quot;_&quot;), ~ .x[1]),
         Response = str_replace_all(Response, &quot;BODYMASS&quot;, &quot;Body mass&quot;),
         Response = str_replace_all(Response, &quot;ACTIVITY&quot;, &quot;Activity&quot;),
         Response = str_replace_all(Response, &quot;VCO2&quot;, &quot;RQ&quot;),
         Parameter = str_replace_all(Parameter, &quot;BODYMASS&quot;, &quot;Body mass&quot;),
         Parameter = str_replace_all(Parameter, &quot;ACTIVITY&quot;, &quot;Activity&quot;),
         Parameter = str_remove_all(Parameter, &quot;.+_&quot;),
         Parameter = str_replace_all(Parameter, &quot;SELECTIONPoly&quot;, &quot;Polyandry&quot;),
         Parameter = str_replace_all(Parameter, &quot;CYCLEIII&quot;, &quot;Cycle III&quot;),
         Parameter = str_replace_all(Parameter, &quot;CYCLEII&quot;, &quot;Cycle II&quot;),
         Parameter = str_replace_all(Parameter, &quot;SEXM&quot;, &quot;Male&quot;),
         Parameter = str_replace_all(Parameter, &quot;:&quot;, &quot; x &quot;)) %&gt;%
  select(Response, Parameter, everything()) %&gt;%
  mutate(Response = factor(Response, 
                           c(&quot;Activity&quot;, &quot;Body mass&quot;, &quot;VO2&quot;, &quot;RQ&quot;))) %&gt;%
  arrange(Response) %&gt;% select(-Response) %&gt;%
  kable(digits = 3) %&gt;% kable_styling() %&gt;%
  group_rows(&quot;Activity level&quot;, 1, 6) %&gt;%
  group_rows(&quot;Body mass&quot;, 7, 10) %&gt;%
  group_rows(&quot;VO2&quot;, 11, 28) %&gt;%
  group_rows(&quot;Respiratory quotient (RQ)&quot;, 29, 46)</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Parameter
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
<th style="text-align:right;">
p
</th>
<th style="text-align:left;">
</th>
</tr>
</thead>
<tbody>
<tr grouplength="6">
<td colspan="7" style="border-bottom: 1px solid;">
<strong>Activity level</strong>
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Intercept
</td>
<td style="text-align:right;">
-4.240
</td>
<td style="text-align:right;">
0.207
</td>
<td style="text-align:right;">
-4.650
</td>
<td style="text-align:right;">
-3.838
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry
</td>
<td style="text-align:right;">
0.984
</td>
<td style="text-align:right;">
0.274
</td>
<td style="text-align:right;">
0.447
</td>
<td style="text-align:right;">
1.521
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:left;">
**
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male
</td>
<td style="text-align:right;">
0.186
</td>
<td style="text-align:right;">
0.241
</td>
<td style="text-align:right;">
-0.290
</td>
<td style="text-align:right;">
0.647
</td>
<td style="text-align:right;">
0.217
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Cycle II
</td>
<td style="text-align:right;">
0.101
</td>
<td style="text-align:right;">
0.090
</td>
<td style="text-align:right;">
-0.076
</td>
<td style="text-align:right;">
0.276
</td>
<td style="text-align:right;">
0.127
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Cycle III
</td>
<td style="text-align:right;">
0.034
</td>
<td style="text-align:right;">
0.091
</td>
<td style="text-align:right;">
-0.145
</td>
<td style="text-align:right;">
0.214
</td>
<td style="text-align:right;">
0.349
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male
</td>
<td style="text-align:right;">
0.113
</td>
<td style="text-align:right;">
0.322
</td>
<td style="text-align:right;">
-0.515
</td>
<td style="text-align:right;">
0.751
</td>
<td style="text-align:right;">
0.362
</td>
<td style="text-align:left;">
</td>
</tr>
<tr grouplength="4">
<td colspan="7" style="border-bottom: 1px solid;">
<strong>Body mass</strong>
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Intercept
</td>
<td style="text-align:right;">
0.345
</td>
<td style="text-align:right;">
0.379
</td>
<td style="text-align:right;">
-0.404
</td>
<td style="text-align:right;">
1.092
</td>
<td style="text-align:right;">
0.155
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry
</td>
<td style="text-align:right;">
0.583
</td>
<td style="text-align:right;">
0.542
</td>
<td style="text-align:right;">
-0.502
</td>
<td style="text-align:right;">
1.650
</td>
<td style="text-align:right;">
0.119
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male
</td>
<td style="text-align:right;">
-1.046
</td>
<td style="text-align:right;">
0.270
</td>
<td style="text-align:right;">
-1.571
</td>
<td style="text-align:right;">
-0.514
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male
</td>
<td style="text-align:right;">
-0.462
</td>
<td style="text-align:right;">
0.382
</td>
<td style="text-align:right;">
-1.215
</td>
<td style="text-align:right;">
0.291
</td>
<td style="text-align:right;">
0.110
</td>
<td style="text-align:left;">
</td>
</tr>
<tr grouplength="18">
<td colspan="7" style="border-bottom: 1px solid;">
<strong>VO2</strong>
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Intercept
</td>
<td style="text-align:right;">
7.582
</td>
<td style="text-align:right;">
0.707
</td>
<td style="text-align:right;">
6.212
</td>
<td style="text-align:right;">
8.985
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry
</td>
<td style="text-align:right;">
0.295
</td>
<td style="text-align:right;">
0.979
</td>
<td style="text-align:right;">
-1.661
</td>
<td style="text-align:right;">
2.186
</td>
<td style="text-align:right;">
0.367
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male
</td>
<td style="text-align:right;">
-1.135
</td>
<td style="text-align:right;">
0.815
</td>
<td style="text-align:right;">
-2.754
</td>
<td style="text-align:right;">
0.488
</td>
<td style="text-align:right;">
0.082
</td>
<td style="text-align:left;">
~
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Cycle II
</td>
<td style="text-align:right;">
-1.290
</td>
<td style="text-align:right;">
0.428
</td>
<td style="text-align:right;">
-2.130
</td>
<td style="text-align:right;">
-0.459
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:left;">
**
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Cycle III
</td>
<td style="text-align:right;">
-1.788
</td>
<td style="text-align:right;">
0.429
</td>
<td style="text-align:right;">
-2.637
</td>
<td style="text-align:right;">
-0.945
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
***
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Body mass
</td>
<td style="text-align:right;">
0.116
</td>
<td style="text-align:right;">
0.669
</td>
<td style="text-align:right;">
-1.184
</td>
<td style="text-align:right;">
1.435
</td>
<td style="text-align:right;">
0.433
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Activity
</td>
<td style="text-align:right;">
5.318
</td>
<td style="text-align:right;">
2.867
</td>
<td style="text-align:right;">
-0.235
</td>
<td style="text-align:right;">
10.904
</td>
<td style="text-align:right;">
0.031
</td>
<td style="text-align:left;">
*
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male
</td>
<td style="text-align:right;">
1.024
</td>
<td style="text-align:right;">
1.135
</td>
<td style="text-align:right;">
-1.200
</td>
<td style="text-align:right;">
3.236
</td>
<td style="text-align:right;">
0.182
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Cycle II
</td>
<td style="text-align:right;">
0.763
</td>
<td style="text-align:right;">
0.592
</td>
<td style="text-align:right;">
-0.397
</td>
<td style="text-align:right;">
1.923
</td>
<td style="text-align:right;">
0.098
</td>
<td style="text-align:left;">
~
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Cycle III
</td>
<td style="text-align:right;">
0.053
</td>
<td style="text-align:right;">
0.596
</td>
<td style="text-align:right;">
-1.133
</td>
<td style="text-align:right;">
1.227
</td>
<td style="text-align:right;">
0.464
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Cycle II
</td>
<td style="text-align:right;">
0.143
</td>
<td style="text-align:right;">
0.599
</td>
<td style="text-align:right;">
-1.042
</td>
<td style="text-align:right;">
1.308
</td>
<td style="text-align:right;">
0.403
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Cycle III
</td>
<td style="text-align:right;">
-0.870
</td>
<td style="text-align:right;">
0.596
</td>
<td style="text-align:right;">
-2.058
</td>
<td style="text-align:right;">
0.288
</td>
<td style="text-align:right;">
0.070
</td>
<td style="text-align:left;">
~
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Body mass
</td>
<td style="text-align:right;">
0.073
</td>
<td style="text-align:right;">
0.721
</td>
<td style="text-align:right;">
-1.353
</td>
<td style="text-align:right;">
1.473
</td>
<td style="text-align:right;">
0.457
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Activity
</td>
<td style="text-align:right;">
3.669
</td>
<td style="text-align:right;">
2.907
</td>
<td style="text-align:right;">
-2.052
</td>
<td style="text-align:right;">
9.380
</td>
<td style="text-align:right;">
0.105
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Body mass
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.576
</td>
<td style="text-align:right;">
-0.875
</td>
<td style="text-align:right;">
1.392
</td>
<td style="text-align:right;">
0.331
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Activity
</td>
<td style="text-align:right;">
2.494
</td>
<td style="text-align:right;">
2.956
</td>
<td style="text-align:right;">
-3.327
</td>
<td style="text-align:right;">
8.273
</td>
<td style="text-align:right;">
0.200
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male x Cycle II
</td>
<td style="text-align:right;">
-0.323
</td>
<td style="text-align:right;">
0.826
</td>
<td style="text-align:right;">
-1.945
</td>
<td style="text-align:right;">
1.318
</td>
<td style="text-align:right;">
0.347
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male x Cycle III
</td>
<td style="text-align:right;">
0.836
</td>
<td style="text-align:right;">
0.825
</td>
<td style="text-align:right;">
-0.796
</td>
<td style="text-align:right;">
2.447
</td>
<td style="text-align:right;">
0.155
</td>
<td style="text-align:left;">
</td>
</tr>
<tr grouplength="18">
<td colspan="7" style="border-bottom: 1px solid;">
<strong>Respiratory quotient (RQ)</strong>
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Intercept
</td>
<td style="text-align:right;">
0.069
</td>
<td style="text-align:right;">
0.581
</td>
<td style="text-align:right;">
-1.075
</td>
<td style="text-align:right;">
1.252
</td>
<td style="text-align:right;">
0.452
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry
</td>
<td style="text-align:right;">
0.023
</td>
<td style="text-align:right;">
0.817
</td>
<td style="text-align:right;">
-1.607
</td>
<td style="text-align:right;">
1.674
</td>
<td style="text-align:right;">
0.489
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male
</td>
<td style="text-align:right;">
0.399
</td>
<td style="text-align:right;">
0.759
</td>
<td style="text-align:right;">
-1.054
</td>
<td style="text-align:right;">
1.937
</td>
<td style="text-align:right;">
0.300
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Cycle II
</td>
<td style="text-align:right;">
0.538
</td>
<td style="text-align:right;">
0.506
</td>
<td style="text-align:right;">
-0.415
</td>
<td style="text-align:right;">
1.571
</td>
<td style="text-align:right;">
0.140
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Cycle III
</td>
<td style="text-align:right;">
-0.363
</td>
<td style="text-align:right;">
0.488
</td>
<td style="text-align:right;">
-1.361
</td>
<td style="text-align:right;">
0.568
</td>
<td style="text-align:right;">
0.226
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Body mass
</td>
<td style="text-align:right;">
0.345
</td>
<td style="text-align:right;">
0.563
</td>
<td style="text-align:right;">
-0.766
</td>
<td style="text-align:right;">
1.467
</td>
<td style="text-align:right;">
0.264
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Activity
</td>
<td style="text-align:right;">
-1.162
</td>
<td style="text-align:right;">
2.833
</td>
<td style="text-align:right;">
-6.651
</td>
<td style="text-align:right;">
4.364
</td>
<td style="text-align:right;">
0.340
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male
</td>
<td style="text-align:right;">
0.194
</td>
<td style="text-align:right;">
0.948
</td>
<td style="text-align:right;">
-1.706
</td>
<td style="text-align:right;">
2.011
</td>
<td style="text-align:right;">
0.408
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Cycle II
</td>
<td style="text-align:right;">
-0.002
</td>
<td style="text-align:right;">
0.622
</td>
<td style="text-align:right;">
-1.235
</td>
<td style="text-align:right;">
1.209
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Cycle III
</td>
<td style="text-align:right;">
1.015
</td>
<td style="text-align:right;">
0.647
</td>
<td style="text-align:right;">
-0.225
</td>
<td style="text-align:right;">
2.305
</td>
<td style="text-align:right;">
0.055
</td>
<td style="text-align:left;">
~
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Cycle II
</td>
<td style="text-align:right;">
-0.632
</td>
<td style="text-align:right;">
0.770
</td>
<td style="text-align:right;">
-2.149
</td>
<td style="text-align:right;">
0.878
</td>
<td style="text-align:right;">
0.204
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Cycle III
</td>
<td style="text-align:right;">
0.671
</td>
<td style="text-align:right;">
0.907
</td>
<td style="text-align:right;">
-1.048
</td>
<td style="text-align:right;">
2.566
</td>
<td style="text-align:right;">
0.221
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Body mass
</td>
<td style="text-align:right;">
-0.148
</td>
<td style="text-align:right;">
0.579
</td>
<td style="text-align:right;">
-1.287
</td>
<td style="text-align:right;">
1.007
</td>
<td style="text-align:right;">
0.394
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Activity
</td>
<td style="text-align:right;">
-1.492
</td>
<td style="text-align:right;">
2.851
</td>
<td style="text-align:right;">
-7.080
</td>
<td style="text-align:right;">
4.078
</td>
<td style="text-align:right;">
0.297
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Body mass
</td>
<td style="text-align:right;">
-0.675
</td>
<td style="text-align:right;">
0.465
</td>
<td style="text-align:right;">
-1.610
</td>
<td style="text-align:right;">
0.235
</td>
<td style="text-align:right;">
0.068
</td>
<td style="text-align:left;">
~
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Male x Activity
</td>
<td style="text-align:right;">
0.423
</td>
<td style="text-align:right;">
2.957
</td>
<td style="text-align:right;">
-5.292
</td>
<td style="text-align:right;">
6.307
</td>
<td style="text-align:right;">
0.446
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male x Cycle II
</td>
<td style="text-align:right;">
-0.619
</td>
<td style="text-align:right;">
0.940
</td>
<td style="text-align:right;">
-2.471
</td>
<td style="text-align:right;">
1.213
</td>
<td style="text-align:right;">
0.254
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left; padding-left: 2em;" indentlevel="1">
Polyandry x Male x Cycle III
</td>
<td style="text-align:right;">
-1.857
</td>
<td style="text-align:right;">
1.074
</td>
<td style="text-align:right;">
-4.026
</td>
<td style="text-align:right;">
0.180
</td>
<td style="text-align:right;">
0.038
</td>
<td style="text-align:left;">
*
</td>
</tr>
</tbody>
</table>
</div>
<div id="plot-posterior-predictive-checks-1" class="section level3">
<h3>Plot posterior predictive checks</h3>
<p>Again, the fit looks ok.</p>
<pre class="r"><code>pp_check(brms_SEM, resp = &quot;VO2&quot;)</code></pre>
<p><img src="figure/statistics.Rmd/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="extract-the-posterior-estimates-of-the-means" class="section level3">
<h3>Extract the posterior estimates of the means</h3>
<p>These are used for plotting the range of means that is supported by the data, given our priors. The posterior estimates show the mean of each group, accounting for all the random effects (i.e. the design of the experiment), the covariance structure of the response variables, etc.</p>
<p>We will also use these posteriors for hypothesis testing, e.g. to see if the mean body size of the polyandry flies differs from that of monogamy flies, by subtracting one posterior from the other to get the posterior estimate of the <em>difference</em> in means. If most (e.g. &gt;95%) of this posterior difference lies on one side of zero, the two means may be considered ‘significantly different’ as conventionally defined. The magnitude of the difference in means is also an intuitive measure of effect size, and the posterior gives a sense of how precisely we have estimated effect size.</p>
<!-- ```{r posterior_predictions} -->
<!-- new <- scaled_data %>% -->
<!--   select(SELECTION, SEX, CYCLE) %>% -->
<!--   distinct() %>% -->
<!--   mutate(body_subset = TRUE) -->
<!-- # Get the posterior estimate of body weight and activity,  -->
<!-- # for the 4 combinations of sex and monogamy/polandry treatment -->
<!-- bodymass <- brms_SEM %>%  -->
<!--   fitted(new, re_formula = NA,  -->
<!--          resp = "BODYMASS", summary = FALSE) -->
<!-- activity <- brms_SEM %>%  -->
<!--   fitted(new, re_formula = NA,  -->
<!--          resp = "ACTIVITY", summary = FALSE) -->
<!-- new <- left_join( -->
<!--   data.frame(new, t(bodymass)) %>%  -->
<!--     gather(draw, BODYMASS, starts_with("X")) %>% as_tibble(), -->
<!--   data.frame(new, t(activity)) %>%  -->
<!--     gather(draw, ACTIVITY, starts_with("X")) %>% as_tibble(),  -->
<!--   by = c("SELECTION", "SEX", "CYCLE", "body_subset", "draw")) %>% -->
<!--   mutate(draw = as.numeric(str_remove_all(draw, "X"))) -->
<!-- new <- bind_rows( -->
<!--   new %>% mutate(mediators_blocked = "Activity", -->
<!--                  ACTIVITY = 0), -->
<!--   new %>% mutate(mediators_blocked = "Body mass", -->
<!--                  BODYMASS = 0) %>% -->
<!--     mutate(VO2 = as.numeric(NA),  -->
<!--            RQ = as.numeric(NA)) -->
<!-- ) %>% arrange(draw) -->
<!-- #  -->
<!-- # library(future) -->
<!-- # library(future.apply) -->
<!-- # plan("multiprocess") -->
<!-- # 1:5000 -->
<!-- # 5001:10000 -->
<!-- # 10001:15000 -->
<!-- # 15001:20000 -->
<!-- lapply(1:max(new$draw), function(i){ -->
<!--   print(i) -->
<!--   focal <- new[new$draw == i, ] -->
<!--   focal_draw <- focal$draw[1] -->
<!--   focal$VO2 <- fitted(brms_SEM, re_formula = NA, resp = "VO2",  -->
<!--                        newdata = focal, subset = focal_draw)[,1] -->
<!--   focal$RQ <- fitted(brms_SEM, re_formula = NA, resp = "VCO2", nlpar = "RQ",  -->
<!--                       newdata = focal, subset = focal_draw)[,1] -->
<!--   focal %>% saveRDS(glue("output/temp_files/preds_{i}.rds")) -->
<!--   rm(focal) -->
<!-- }) -->
<!-- posterior_predictions <- list.files("output/temp_files", full.names = TRUE) %>% map_df(readRDS) -->
<!-- #   DO THIS AFTER -->
<!-- #   (new[1:12, ]) %>% mutate(mediators_blocked = "Both", -->
<!-- #                            BODYMASS = 0, -->
<!-- #                            ACTIVITY = 0) -->
<!-- posterior_predictions <- posterior_predictions %>% mutate(RQ = 0.7 + 0.3 * inv_logit(RQ)) -->
<!-- # FINISH THIS - OLD VERSION BELOW -->
<!-- #  -->
<!-- # posterior_predictions <- new %>% -->
<!-- #   mutate(chunk = rep(1:(nrow(new) / 1000), each = 1000)) %>% # 720 chunks -->
<!-- #   split(.$chunk) %>% -->
<!-- #   map_df(~ { -->
<!-- #     focal_dat <- .x -->
<!-- #     print(focal_dat$chunk[1]) -->
<!-- #     data.frame(.x, fit = fitted(brms_SEM, re_formula = NA, resp = "VO2", newdata = focal_dat)) -->
<!-- #   }) %>% select(-chunk) %>% -->
<!-- #   rename(VO2 = fit.Estimate) %>%  -->
<!-- #   select(-starts_with("fit")) %>%  -->
<!-- #   as_tibble() -->
<!-- if(!file.exists("data/posterior_predictions.rds")){ -->
<!--   # Calculate the posterior VO2 and RQ for the levels of 'new', either by assuming bodysize and acitivity are at their global means, or by using the means we have estimated for each combination of selection, sex, and cycle -->
<!--   get_post_response <- function(body, act){ -->
<!--     n_combos <- nrow(new) -->
<!--     if(!body) bodyweight <- matrix(0, ncol = n_combos, nrow = 1) -->
<!--     if(!act)  activity <- matrix(0, ncol = n_combos, nrow = 1) -->
<!--     get_diagonal <- function(mat){ -->
<!--       if(ncol(mat) == nrow(mat)) return(diag(mat)) -->
<!--       mat -->
<!--     } -->
<!--     VO2_posterior <- map( -->
<!--       1:n_combos,  -->
<!--       ~ brms_SEM %>%  -->
<!--         fitted(data.frame( -->
<!--           SELECTION = new$SELECTION[.x], -->
<!--           SEX = new$SEX[.x], -->
<!--           CYCLE = new$CYCLE[.x], -->
<!--           BODYMASS = bodymass[, .x],  -->
<!--           ACTIVITY = activity[, .x]),  -->
<!--           re_formula = NA, resp = "VO2",  -->
<!--           summary = FALSE) %>% -->
<!--         get_diagonal()) %>% -->
<!--       do.call("cbind", .) -->
<!--     RQ_posterior <- map( -->
<!--       1:n_combos,  -->
<!--       ~ brms_SEM %>%  -->
<!--         fitted(data.frame( -->
<!--           SELECTION = new$SELECTION[.x], -->
<!--           SEX = new$SEX[.x], -->
<!--           BODYMASS = bodymass[, .x],  -->
<!--           ACTIVITY = activity[, .x], -->
<!--           CYCLE = new$CYCLE[.x], -->
<!--           VO2 = VO2_posterior[, .x]),  -->
<!--           re_formula = NA, resp = "VCO2",  -->
<!--           nlpar = "RQ", summary = FALSE) %>% -->
<!--         get_diagonal()) %>% -->
<!--       do.call("cbind", .) -->
<!--     n_draws <- nrow(VO2_posterior) -->
<!--     posterior <- tibble( -->
<!--       value = c(VO2_posterior), -->
<!--       resp = "VO2", -->
<!--       selection = rep(new$SELECTION, each = n_draws), -->
<!--       sex = rep(new$SEX, each = n_draws), -->
<!--       cycle = rep(new$CYCLE, each = n_draws) -->
<!--     ) %>% bind_rows( -->
<!--       tibble( -->
<!--         value = c(RQ_posterior), -->
<!--         resp = "RQ", -->
<!--         selection = rep(new$SELECTION, each = n_draws), -->
<!--         sex = rep(new$SEX, each = n_draws), -->
<!--         cycle = rep(new$CYCLE, each = n_draws) -->
<!--       ) -->
<!--     ) %>% mutate( -->
<!--       value = ifelse(resp == "RQ",  -->
<!--                      0.7 + 0.3 * inv_logit(value),  -->
<!--                      value)) -->
<!--   } -->
<!--   posterior_predictions <- list( -->
<!--     direct_path = get_post_response(body = F, act = F), -->
<!--     direct_path_plus_bodyweight = get_post_response(body = T, act = F), -->
<!--     direct_path_plus_activity = get_post_response(body = F, act = T), -->
<!--     all_paths = get_post_response(body = T, act = T)) -->
<!--   posterior_predictions <- lapply( -->
<!--     names(posterior_predictions), function(i) { -->
<!--       posterior_predictions[[i]] %>% mutate(path = i) -->
<!--     }) %>% bind_rows() %>% -->
<!--     mutate(path = factor(path, unique(path))) -->
<!--   posterior_predictions <- posterior_predictions %>% -->
<!--     mutate(sex = ifelse(sex == "M", "Male", "Female"), -->
<!--            sex = factor(sex, c("Male", "Female")), -->
<!--            path = replace(as.character(path),  -->
<!--                           path == "direct_path",  -->
<!--                           "1. Direct effect"), -->
<!--            path = replace(path,  -->
<!--                           path == "direct_path_plus_bodyweight",  -->
<!--                           "2. Direct + body mass"), -->
<!--            path = replace(path,  -->
<!--                           path == "direct_path_plus_activity",  -->
<!--                           "3. Direct + activity level"), -->
<!--            path = replace(path,  -->
<!--                           path == "all_paths",  -->
<!--                           "4. Direct + both mediators"))  -->
<!--   posterior_predictions %>%  -->
<!--     saveRDS("data/posterior_predictions.rds") -->
<!-- } else { -->
<!--   posterior_predictions <-  -->
<!--     readRDS("data/posterior_predictions.rds") -->
<!-- } -->
<!-- ``` -->
<!-- ## Effect of selection treatment on mediator variables -->
<!-- Here, we see that triads of flies from the M and P selection treatments differ strongly in activity levels, and (for females) in body mass. Thus, in subsequent analyses, we attempt to partition out the effect of selection on respiration that is due to the difference in body size, activity, or other unmeasured mediator variables (e.g. physiological differences). -->
<!-- ```{r} -->
<!-- parse_mediators <- function(x){ -->
<!--   var <- x -->
<!--   x <- get(x) -->
<!--   colnames(x) <- apply(new[1:12, ], 1, paste0, collapse="~") -->
<!--   gather(as_tibble(x)) %>% -->
<!--     mutate(draw = rep(1:(n()/4), 4), -->
<!--            split = strsplit(key, split = "~"), -->
<!--            selection = map_chr(split, ~.x[1]), -->
<!--            sex = map_chr(split, ~.x[2])) %>% -->
<!--     select(draw, sex, selection, value) %>% -->
<!--     mutate(mediator = var) -->
<!-- } -->
<!-- mediators <- parse_mediators("bodymass") %>% -->
<!--   bind_rows(parse_mediators("activity")) %>% -->
<!--   mutate(mediator = factor(mediator, unique(mediator))) %>% -->
<!--   mutate( -->
<!--     mediator = replace(as.character(mediator),  -->
<!--                        mediator == "bodymass",  -->
<!--                        "A. Body mass"), -->
<!--     mediator = gsub("activity",  -->
<!--                     "B. Activity",  -->
<!--                     mediator), -->
<!--     Sex = relevel(factor(ifelse(sex == "F",  -->
<!--                                 "Female",  -->
<!--                                 "Male")), ref = "Male"), -->
<!--     selection = ifelse(selection == "Mono",  -->
<!--                        "Monogamy",  -->
<!--                        "Polyandry")) -->
<!-- pd <- position_dodge(0.9) -->
<!-- mediator_plot <- function(dat){ -->
<!--   dat  %>% -->
<!--     ggplot(aes(Sex, value, fill = selection)) + -->
<!--     scale_fill_brewer(palette = "Set1", direction = -1, name = "") + -->
<!--     geom_hline(yintercept = 0, linetype = 2) + -->
<!--     stat_eye (alpha = 0.6, position = pd) +  -->
<!--     facet_wrap(~ mediator) + -->
<!--     #coord_cartesian(ylim = c(-2, 2)) + -->
<!--     theme_bw() +  -->
<!--     theme(legend.position = "top", -->
<!--           strip.background = element_blank(), -->
<!--           strip.text = element_text(hjust = 0), -->
<!--           panel.grid.major.y = element_blank()) +  -->
<!--     ylab(NULL) + xlab(NULL)  -->
<!-- } -->
<!-- grid.arrange( -->
<!--   mediators  %>% -->
<!--     filter(mediator == "A. Body mass") %>% -->
<!--     mediator_plot() + coord_cartesian(ylim = c(-2.4, 2.8)), -->
<!--   mediators  %>% -->
<!--     filter(mediator == "B. Activity") %>% -->
<!--     mediator_plot() + coord_cartesian(ylim = c(0, 0.1)),  -->
<!--   ncol = 2, left = "Mean trait value (posterior estimate)", bottom = "Sex") -->
<!-- ``` -->
<!-- **Figure 2:** Polyandry females were larger than monogamy females, and polyandry flies of both sexes were more active than monogamy flies. The y-axis shows the posterior estimate of the mean trait value (scaled to have mean zero, SD = 1). The coloured areas show the posterior distribution, the black circles show the median, the thick bars show the 95% credible intervals on the median, and the thin bars show the 95% quantiles of the posterior.  -->
<!-- ```{r echo=F} -->
<!-- mediator_plot <- grid.arrange( -->
<!--   mediators  %>% -->
<!--     filter(mediator == "A. Body mass") %>% -->
<!--     mediator_plot() + coord_cartesian(ylim = c(-2.4, 2.8)), -->
<!--   mediators  %>% -->
<!--     filter(mediator == "B. Activity") %>% -->
<!--     mediator_plot() + coord_cartesian(ylim = c(0, 0.1)),  -->
<!--   ncol = 2, left = "Mean trait value (posterior estimate)", bottom = "Sex") -->
<!-- ggsave(mediator_plot, filename = "output/Figure 2.pdf", width = 7, height = 4) -->
<!-- ``` -->
<!-- ## Effect of selection treatment on respiration -->
<!-- ### Plot the posterior means for VO2 -->
<!-- The plot show the model's best estimates of the mean, with the shading showing the posterior distribution of these guesses. The four rows show the effect of: -->
<!-- - selection on VO2, independently of both mediator variables -->
<!-- - selection on VO2, independently of activity level but incorporating the mediating effect of body mass -->
<!-- - selection on VO2, independently of body weight but incorporating the mediating effect of activity level -->
<!-- - selection on VO2, including the effects of both mediator variables -->
<!-- ```{r} -->
<!-- # new one: -->
<!-- posterior_predictions %>%  -->
<!--  # filter(!is.na(VO2) & VO2 != 0) %>% -->
<!--   group_by(mediators_blocked) %>% -->
<!--   mutate(VO2 = as.numeric(scale(VO2))) %>% -->
<!--   ggplot(aes(x = CYCLE, y = RQ, fill = SELECTION)) + -->
<!--   scale_fill_brewer(palette = "Set1", direction = -1, name = NULL) + -->
<!--   geom_eye (alpha=0.6, .width = c(0.88), position = pd) + -->
<!-- #  geom_point (alpha=0.6, .width = c(0.88), position = pd) + -->
<!--  # coord_cartesian(ylim = c(-3.5, 2.8)) + -->
<!--   facet_grid(mediators_blocked~SEX) +  -->
<!--   theme_bw() +  -->
<!--   theme(legend.position = "top", -->
<!--         panel.grid.major.x = element_blank()) +    -->
<!--   xlab("Cycle") +  -->
<!--   ylab("Oxygen consumption (Posterior estimate of mean VO2)")  -->
<!-- ``` -->
<!-- ```{r fig.height=11, fig.width=9} -->
<!-- posterior_predictions %>%  -->
<!--   filter(resp == "VO2") %>% -->
<!--   filter(grepl("2.", path) | grepl("4.", path)) %>% -->
<!--   mutate(path = replace(path, grepl("4.", path), "Effect of treatment")) -->
<!--   ggplot(aes(x = cycle, y = scale(value), fill = selection)) + -->
<!--   scale_fill_brewer(palette = "Set1", direction = -1, name = NULL) + -->
<!--   geom_eye (alpha=0.6, .width = c(0.88), position = pd) + -->
<!--   coord_cartesian(ylim = c(-3.5, 2.8)) + -->
<!--   facet_grid(path~sex) +  -->
<!--   theme_bw() +  -->
<!--   theme(legend.position = "top", -->
<!--         panel.grid.major.x = element_blank()) +    -->
<!--   xlab("Cycle") +  -->
<!--   ylab("Oxygen consumption (Posterior estimate of mean VO2)")  -->
<!-- ``` -->
<!-- ### Plot the posterior means for RQ -->
<!-- ```{r fig.height=11, fig.width=9} -->
<!-- posterior_predictions %>% -->
<!--   filter(resp == "RQ") %>% -->
<!--   ggplot(aes(x = cycle, y = value, fill = selection)) + -->
<!--   scale_fill_brewer(palette = "Set1", direction = -1) + -->
<!--   geom_eye (alpha=0.6, .width = c(0.88), position = pd) + -->
<!--   facet_grid(path~sex) +  -->
<!--   theme_bw() +  -->
<!--   theme(legend.position = "top", -->
<!--         panel.grid.major.x = element_blank()) +    -->
<!--   xlab("Cycle") +  -->
<!--   ylab("RQ (Posterior estimate of group means)") -->
<!-- ``` -->
<!-- ## Table of posterior means {.tabset} -->
<!-- These tables show the mean values of VO2 and RQ in each treatment/cycle/sex combination. -->
<!-- ```{r} -->
<!-- tableS1_S2 <- posterior_predictions %>% -->
<!--   group_by(resp, path, cycle, sex, selection) %>% -->
<!--   summarise(x = list(posterior_summary(value))) %>% -->
<!--   mutate(Estimate = map_dbl(x, ~ .x[1]), -->
<!--          Error = map_dbl(x, ~ .x[2]), -->
<!--          Lower95CI = map_dbl(x, ~ .x[3]), -->
<!--          Upper95CI = map_dbl(x, ~ .x[4])) %>%  -->
<!--   select(-x) %>% ungroup() -->
<!-- tableS1 <- tableS1_S2 %>% -->
<!--   filter(resp == "VO2") %>% -->
<!--   rename(`Mean VO2` = Estimate) %>% -->
<!--   select(-resp) -->
<!-- tableS2 <- tableS1_S2 %>% -->
<!--   filter(resp == "RQ") %>% -->
<!--   rename(`Mean RQ` = Estimate) %>% -->
<!--   select(-resp) -->
<!-- ``` -->
<!-- ### VO2 -->
<!-- ```{r} -->
<!-- tableS1 %>% kable(digits=3) %>% kable_styling() -->
<!-- ``` -->
<!-- ### RQ -->
<!-- ```{r} -->
<!-- tableS2 %>% kable(digits=3) %>% kable_styling() -->
<!-- ``` -->
<!-- ## Tables of posterior differences between selection treatments -->
<!-- The table tests for differences between the M and P treatments in VO2 and RQ. It was calculated as the difference in mean VO2 or RQ between M and P, either alone, or including one or both of the two mediator variables (body size and activity level). The comparison was made separately in each sex/cycle combination. The biggest effect is on males in cycle III: the M males are less active, and therefore they respire less -- there was no evidence for a treatment effect unless the effect of selection on activity level was considered. There were no treatment effects on RQ. -->
<!-- ```{r make_posterior_diff_table} -->
<!-- my_summary <- function(posterior) {  -->
<!--   p <- (100 - as.numeric(p_direction(posterior))) / 100  -->
<!--   posterior_summary(posterior) %>%   -->
<!--     as.data.frame() %>%  -->
<!--     mutate(p = p) %>% -->
<!--     mutate(` ` = ifelse(p < 0.05, "\\*", ""), -->
<!--            ` ` = replace(` `, p > 0.05 & p < 0.1, "~"), -->
<!--            ` ` = replace(` `, p < 0.01, "**"),  -->
<!--            ` ` = replace(` `, p < 0.001, "***"))  -->
<!-- }  -->
<!-- make_posterior_diff_table <- function(posterior_predictions){ -->
<!--   posterior_differences <- posterior_predictions %>% -->
<!--     group_by(resp, path, sex, cycle) %>% -->
<!--     summarise(x = list(my_summary( -->
<!--       value[selection=="Mono"] -  -->
<!--         value[selection=="Poly"])))  -->
<!--   bind_cols( -->
<!--     posterior_differences[,-5],  -->
<!--     do.call("rbind", posterior_differences %>% pull(5)))  %>% -->
<!--     arrange(desc(resp))  -->
<!-- } -->
<!-- posterior_differences <- posterior_predictions %>%  -->
<!--   make_posterior_diff_table() -->
<!-- posterior_differences %>%  -->
<!--   kable(digits=3) %>%  -->
<!--   kable_styling() -->
<!-- ``` -->
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.6.2 (2019-12-12)
Platform: x86_64-apple-darwin15.6.0 (64-bit)
Running under: macOS High Sierra 10.13.6

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib

locale:
[1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] future.apply_1.4.0 future_1.16.0      ggridges_0.5.2     MuMIn_1.43.15     
 [5] bayestestR_0.5.1   tidybayes_2.0.1    kableExtra_1.1.0   glue_1.3.1        
 [9] RColorBrewer_1.1-2 brms_2.11.1        Rcpp_1.0.3         gridExtra_2.3     
[13] forcats_0.4.0      stringr_1.4.0      dplyr_0.8.4        purrr_0.3.3       
[17] readr_1.3.1        tidyr_1.0.2        tibble_2.1.3       ggplot2_3.2.1     
[21] tidyverse_1.3.0   

loaded via a namespace (and not attached):
  [1] readxl_1.3.1         backports_1.1.5      workflowr_1.6.0     
  [4] plyr_1.8.5           igraph_1.2.4.2       lazyeval_0.2.2      
  [7] splines_3.6.2        svUnit_0.7-12        crosstalk_1.0.0     
 [10] listenv_0.8.0        rstantools_2.0.0     inline_0.3.15       
 [13] digest_0.6.23        htmltools_0.4.0      rsconnect_0.8.16    
 [16] fansi_0.4.1          magrittr_1.5         globals_0.12.5      
 [19] modelr_0.1.5         matrixStats_0.55.0   xts_0.12-0          
 [22] prettyunits_1.1.1    colorspace_1.4-1     rvest_0.3.5         
 [25] haven_2.2.0          xfun_0.12            callr_3.4.1         
 [28] crayon_1.3.4         jsonlite_1.6.1       lme4_1.1-21         
 [31] zoo_1.8-7            gtable_0.3.0         webshot_0.5.2       
 [34] pkgbuild_1.0.6       rstan_2.19.2         abind_1.4-5         
 [37] scales_1.1.0         mvtnorm_1.0-12       DBI_1.1.0           
 [40] miniUI_0.1.1.1       viridisLite_0.3.0    xtable_1.8-4        
 [43] stats4_3.6.2         StanHeaders_2.21.0-1 DT_0.12             
 [46] htmlwidgets_1.5.1    httr_1.4.1           threejs_0.3.3       
 [49] DiagrammeR_1.0.5     arrayhelpers_1.1-0   ellipsis_0.3.0      
 [52] pkgconfig_2.0.3      loo_2.2.0            farver_2.0.3        
 [55] dbplyr_1.4.2         tidyselect_1.0.0     labeling_0.3        
 [58] rlang_0.4.4          reshape2_1.4.3       later_1.0.0         
 [61] munsell_0.5.0        cellranger_1.1.0     tools_3.6.2         
 [64] visNetwork_2.0.9     cli_2.0.1            generics_0.0.2      
 [67] broom_0.5.4          evaluate_0.14        fastmap_1.0.1       
 [70] yaml_2.2.1           processx_3.4.2       knitr_1.28          
 [73] fs_1.3.1             nlme_3.1-144         whisker_0.4         
 [76] mime_0.9             xml2_1.2.2           compiler_3.6.2      
 [79] bayesplot_1.7.1      shinythemes_1.1.2    rstudioapi_0.11     
 [82] reprex_0.3.0         stringi_1.4.5        highr_0.8           
 [85] ps_1.3.0             Brobdingnag_1.2-6    lattice_0.20-38     
 [88] Matrix_1.2-18        nloptr_1.2.1         markdown_1.1        
 [91] shinyjs_1.1          vctrs_0.2.2          pillar_1.4.3        
 [94] lifecycle_0.1.0      bridgesampling_0.8-1 insight_0.8.1       
 [97] httpuv_1.5.2         R6_2.4.1             promises_1.1.0      
[100] codetools_0.2-16     boot_1.3-24          colourpicker_1.0    
[103] MASS_7.3-51.5        gtools_3.8.1         assertthat_0.2.1    
[106] rprojroot_1.3-2      withr_2.1.2          shinystan_2.5.0     
[109] parallel_3.6.2       hms_0.5.3            grid_3.6.2          
[112] minqa_1.2.4          coda_0.19-3          rmarkdown_2.1       
[115] git2r_0.26.1         shiny_1.4.0          lubridate_1.7.4     
[118] base64enc_0.1-3      dygraphs_1.1.1.6    </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
